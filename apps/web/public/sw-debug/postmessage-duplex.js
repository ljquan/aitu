const e="postmessage-duplex",t="1.0.0",i="undefined"!=typeof window?window:"undefined"!=typeof self?self:{};var s,r;i.__POSTMESSAGE_DUPLEX__||(i.__POSTMESSAGE_DUPLEX__={}),i.__POSTMESSAGE_DUPLEX__.version=t,i.__POSTMESSAGE_DUPLEX__.name=e,function(e){e[e.Success=0]="Success",e[e.ReceiverCallbackError=-1]="ReceiverCallbackError",e[e.SendCallbackError=-2]="SendCallbackError",e[e.NoSubscribe=-3]="NoSubscribe",e[e.TimeOut=-99]="TimeOut"}(s||(s={})),function(e){e.ConnectionDestroyed="CONNECTION_DESTROYED",e.ConnectionTimeout="CONNECTION_TIMEOUT",e.MethodCallTimeout="METHOD_CALL_TIMEOUT",e.MethodNotFound="METHOD_NOT_FOUND",e.TransmissionFailed="TRANSMISSION_FAILED",e.MessageSizeExceeded="MESSAGE_SIZE_EXCEEDED",e.RateLimitExceeded="RATE_LIMIT_EXCEEDED",e.HandlerError="HANDLER_ERROR",e.InvalidMessage="INVALID_MESSAGE",e.OriginMismatch="ORIGIN_MISMATCH"}(r||(r={}));class n extends Error{constructor(e,t,i){super(e),Object.defineProperty(this,"code",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"details",{enumerable:1,configurable:1,writable:1,value:void 0}),this.name="ChannelError",this.code=t,this.details=i,Error.captureStackTrace&&Error.captureStackTrace(this,n)}toJSON(){return{name:this.name,message:this.message,code:this.code,details:this.details,stack:this.stack}}}function o(e){return new n("Channel has been destroyed",r.ConnectionDestroyed,e?{requestId:e}:void 0)}function a(e,t){return new n(`Request "${e}" timed out after ${t}ms`,r.MethodCallTimeout,{cmdname:e,timeout:t})}function h(e,t){return new n(t.message||`Handler for "${e}" threw an error`,r.HandlerError,{cmdname:e,originalError:t.message,stack:t.stack})}class l{constructor(){Object.defineProperty(this,"timeouts",{enumerable:1,configurable:1,writable:1,value:new Map}),Object.defineProperty(this,"timer",{enumerable:1,configurable:1,writable:1,value:null}),Object.defineProperty(this,"nextDeadline",{enumerable:1,configurable:1,writable:1,value:1/0}),Object.defineProperty(this,"destroyed",{enumerable:1,configurable:1,writable:1,value:0})}add(e,t,i){if(this.destroyed)return;const s=Date.now()+t;this.timeouts.set(e,{deadline:s,callback:i}),s<this.nextDeadline&&this.reschedule(s)}remove(e){return this.timeouts.delete(e)}has(e){return this.timeouts.has(e)}get size(){return this.timeouts.size}reschedule(e){null!==this.timer&&clearTimeout(this.timer),this.nextDeadline=e;const t=Math.max(0,e-Date.now());this.timer=setTimeout(()=>this.processTimeouts(),t)}processTimeouts(){if(this.destroyed)return;const e=Date.now(),t=[];for(const[i,{deadline:s,callback:r}]of this.timeouts)s<=e&&(t.push(r),this.timeouts.delete(i));for(const e of t)try{e()}catch(e){console.error("[TimeoutManager] Callback error:",e)}this.scheduleNext()}scheduleNext(){if(0===this.timeouts.size)return this.nextDeadline=1/0,void(this.timer=null);let e=1/0;for(const{deadline:t}of this.timeouts.values())t<e&&(e=t);e<1/0&&this.reschedule(e)}destroy(){this.destroyed=1,null!==this.timer&&(clearTimeout(this.timer),this.timer=null),this.timeouts.clear(),this.nextDeadline=1/0}clear(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null),this.timeouts.clear(),this.nextDeadline=1/0}}class c{constructor(e,t=1e3){Object.defineProperty(this,"limit",{enumerable:1,configurable:1,writable:1,value:e}),Object.defineProperty(this,"windowMs",{enumerable:1,configurable:1,writable:1,value:t}),Object.defineProperty(this,"timestamps",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"head",{enumerable:1,configurable:1,writable:1,value:0}),Object.defineProperty(this,"tail",{enumerable:1,configurable:1,writable:1,value:0}),Object.defineProperty(this,"count",{enumerable:1,configurable:1,writable:1,value:0}),Object.defineProperty(this,"enabled",{enumerable:1,configurable:1,writable:1,value:void 0}),this.enabled=e>0,this.timestamps=this.enabled?new Array(e).fill(0):[]}tryAcquire(){if(!this.enabled)return 1;const e=Date.now(),t=e-this.windowMs;for(;this.count>0&&this.timestamps[this.head]<=t;)this.head=(this.head+1)%this.limit,this.count--;return this.count>=this.limit?0:(this.timestamps[this.tail]=e,this.tail=(this.tail+1)%this.limit,this.count++,1)}getCurrentCount(){if(!this.enabled)return 0;const e=Date.now()-this.windowMs;let t=0,i=this.head;for(let s=0;s<this.count;s++)this.timestamps[i]>e&&t++,i=(i+1)%this.limit;return t}getRemainingCapacity(){return this.enabled?Math.max(0,this.limit-this.getCurrentCount()):1/0}getTimeUntilAvailable(){if(!this.enabled||this.count<this.limit)return 0;const e=Date.now()-this.windowMs;let t=this.head;for(;t!==this.tail;){if(this.timestamps[t]>e)return this.timestamps[t]-e;t=(t+1)%this.limit}return 0}isLimited(){return this.enabled?this.getCurrentCount()>=this.limit:0}reset(){this.head=0,this.tail=0,this.count=0,this.enabled&&this.timestamps.fill(0)}getLimit(){return this.limit}getWindowMs(){return this.windowMs}isEnabled(){return this.enabled}}class u{constructor(){Object.defineProperty(this,"eventHandlers",{enumerable:1,configurable:1,writable:1,value:new Map}),Object.defineProperty(this,"eventsEnabled",{enumerable:1,configurable:1,writable:1,value:1})}on(e,t){let i=this.eventHandlers.get(e);return i||(i=new Set,this.eventHandlers.set(e,i)),i.add(t),()=>{i?.delete(t),0===i?.size&&this.eventHandlers.delete(e)}}once(e,t){const i=s=>{this.off(e,i),t(s)};return this.on(e,i)}off(e,t){const i=this.eventHandlers.get(e);if(!i)return 0;const s=i.delete(t);return 0===i.size&&this.eventHandlers.delete(e),s}offAll(e){e?this.eventHandlers.delete(e):this.eventHandlers.clear()}emit(e,t){if(!this.eventsEnabled)return;const i=this.eventHandlers.get(e);if(i)for(const s of[...i])try{s(t)}catch(t){console.error(`[ChannelEventEmitter] Error in ${e} handler:`,t)}}hasListeners(e){const t=this.eventHandlers.get(e);return void 0!==t&&t.size>0}listenerCount(e){return this.eventHandlers.get(e)?.size??0}setEventsEnabled(e){this.eventsEnabled=e}destroyEventEmitter(){this.eventHandlers.clear(),this.eventsEnabled=0}}function d(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function b(e){return"string"==typeof e&&e.length>0}const m=e=>({valid:0,error:e});function g(e){if(!d(e))return m("Message must be an object");const t=e,i="requestId"in t,r="cmdname"in t,n="msg"in t,o="ret"in t;return i||r||n?i&&"string"!=typeof t.requestId?m("requestId must be a string"):r&&"string"!=typeof t.cmdname?m("cmdname must be a string"):n&&"string"!=typeof t.msg?m("msg must be a string"):!o||"number"==typeof(a=t.ret)&&Object.values(s).includes(a)?"data"in t&&void 0!==t.data&&!d(t.data)?m("data must be an object"):"t"in t&&void 0!==t.t&&"string"!=typeof t.t?m("_senderKey must be a string"):!("time"in t)||void 0===t.time||"number"==typeof t.time&&Number.isFinite(t.time)?{valid:1,message:t}:m("time must be a finite number"):m("ret must be a valid ReturnCode"):m("Message must have requestId, cmdname, or msg field");var a}function f(e){const t=g(e);return t.valid?b(t.message.requestId)?b(t.message.cmdname)?t:m("Request must have a non-empty cmdname"):m("Request must have a non-empty requestId"):t}function v(e){const t=g(e);return t.valid?"ret"in t.message?t:m("Response must have a ret field"):t}function w(e){return"ret"in e&&"number"==typeof e.ret}function p(e){return"ready"===e.msg}function y(e){const t={};for(const i of["requestId","cmdname","ret","msg","time","_senderKey"])i in e&&(t[i]=e[i]);if("data"in e&&void 0!==e.data)try{t.data=JSON.parse(JSON.stringify(e.data))}catch{t.data="[Unserializable]"}return t}function O(e){try{const t=JSON.stringify(e);return"undefined"!=typeof Blob?new Blob([t]).size:2*t.length}catch{return 1/0}}const S="undefined"!=typeof window?window:"undefined"!=typeof self?self:{},E=[],M=[],C={totalSent:0,totalReceived:0,timeouts:0,errors:0,activeChannels:0};let I=0;function j(e){M.length>=200&&M.shift(),M.push(e)}function $(e,t){for(let i=M.length-1;i>=0;i--)if(M[i].requestId===e&&"pending"===M[i].status){M[i].status=t,M[i].duration=Date.now()-M[i].timestamp;break}}function T(){const e=new Date;return`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}.${String(e.getMilliseconds()).padStart(3,"0")}`}function D(e,t,i,s=0){const r=T();console.log(`%c[${r}] ${"send"===e?"ðŸ“¤":"ðŸ“¥"} ${"send"===e?"â†’":"â†"} ${t||i}${s?" (response)":""}`,`color: ${"send"===e?"#2196F3":"#4CAF50"}; font-weight: bold`)}class q{help(){console.log(`\n%câ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘           PostMessage Channel Debugger v${t.padEnd(10)}          â•‘\nâ• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\nâ•‘  Available Commands:                                         â•‘\nâ•‘                                                              â•‘\nâ•‘  debug.help()              - Show this help message          â•‘\nâ•‘  debug.getChannels()       - List all active channels        â•‘\nâ•‘  debug.getHistory(opts?)   - View message history            â•‘\nâ•‘  debug.enableLiveLog(bool) - Toggle real-time logging        â•‘\nâ•‘  debug.getPending()        - List pending requests           â•‘\nâ•‘  debug.getStats()          - Show statistics                 â•‘\nâ•‘  debug.exportReport()      - Export debug report as JSON     â•‘\nâ•‘  debug.clear()             - Clear history and stats         â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,"color: #2196F3; font-family: monospace")}getChannels(){const e=[],t=[];for(const i of E){const s=i.deref();if(s){t.push(i);const r={type:s.channelType||"unknown",isReady:s.isReady,isDestroyed:s.isDestroyed||0,baseKey:s.baseKey||"",peerKey:s.getPeerKey(),pendingCount:s.getPendingCount(),subscriptions:Array.from(s.subscribeMap?.keys()||[])};"function"==typeof s.getTargetOrigin&&(r.targetOrigin=s.getTargetOrigin()),e.push(r)}}return E.length=0,E.push(...t),C.activeChannels=t.length,0===e.length?console.log("%cNo active channels found.","color: #999"):e.forEach((e,t)=>{const i=e.isDestroyed?"#999":e.isReady?"#4CAF50":"#FF9800";console.log(`\n%cChannel #${t+1} (${e.type})\n%câ”œâ”€ Status: ${e.isDestroyed?"ðŸ’€":e.isReady?"âœ“":"â³"} ${e.isDestroyed?"Destroyed":e.isReady?"Ready":"Connecting"}\nâ”œâ”€ BaseKey: ${e.baseKey}\nâ”œâ”€ PeerKey: ${e.peerKey||"(not paired)"}\nâ”œâ”€ Pending: ${e.pendingCount} requests\nâ”œâ”€ Subscriptions: ${e.subscriptions.join(", ")||"(none)"}\n${e.targetOrigin?`â””â”€ Target: ${e.targetOrigin}`:"â””â”€ (no target info)"}`,"color: #2196F3; font-weight: bold",`color: ${i}`)}),e}getHistory(e){let t=[...M];if(e?.filter){const i=e.filter.toLowerCase();t=t.filter(e=>e.cmdname.toLowerCase().includes(i)||e.requestId.toLowerCase().includes(i))}if(e?.limit&&e.limit>0&&(t=t.slice(-e.limit)),0===t.length)console.log("%cNo message history.","color: #999");else{const e=t.map(e=>({Dir:"send"===e.direction?"â†’":"â†",Command:e.cmdname||e.requestId.slice(-8),Status:"ok"===e.status?"âœ“":"timeout"===e.status?"â±":"error"===e.status?"âœ—":"...",Time:void 0!==e.duration?`${e.duration}ms`:"-",Timestamp:new Date(e.timestamp).toLocaleTimeString("en-US",{hour12:0})}));console.table(e)}return t}enableLiveLog(e){I=e,e?console.log("%cðŸ”´ Live logging ENABLED. Messages will appear in real-time.","color: #4CAF50; font-weight: bold"):console.log("%câšª Live logging DISABLED.","color: #999")}getPending(){const e=[];return E.forEach((t,i)=>{const s=t.deref();if(s){const t=s.requestCmdMap;if(t)for(const[s,r]of t)e.push({channelIndex:i,requestId:s,cmdname:r})}}),0===e.length?console.log("%cNo pending requests.","color: #999"):console.table(e),e}getStats(){return console.log(`\n%câ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘     PostMessage Channel Statistics   â•‘\nâ• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\nâ•‘  ðŸ“¤ Total Sent:      ${String(C.totalSent).padStart(10)}     â•‘\nâ•‘  ðŸ“¥ Total Received:  ${String(C.totalReceived).padStart(10)}     â•‘\nâ•‘  â±  Timeouts:        ${String(C.timeouts).padStart(10)}     â•‘\nâ•‘  âŒ Errors:          ${String(C.errors).padStart(10)}     â•‘\nâ•‘  ðŸ“¡ Active Channels: ${String(C.activeChannels).padStart(10)}     â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,"color: #2196F3; font-family: monospace"),{...C}}exportReport(){const i={version:t,name:e,timestamp:(new Date).toISOString(),stats:{...C},channels:this.getChannels(),history:M.slice(-100),pending:this.getPending()},s=JSON.stringify(i,null,2);return console.log("%cDebug report exported. Use copy() to copy to clipboard.","color: #4CAF50"),s}clear(){M.length=0,C.totalSent=0,C.totalReceived=0,C.timeouts=0,C.errors=0,console.log("%cHistory and stats cleared.","color: #999")}isLiveLogEnabled(){return I}}let k=null;function N(){return k||(k=new q),S.__POSTMESSAGE_DUPLEX__||(S.__POSTMESSAGE_DUPLEX__={}),Object.defineProperty(S.__POSTMESSAGE_DUPLEX__,"debug",{value:k,writable:0,configurable:1}),console.log("%cðŸ”§ PostMessage Debugger enabled. Type __POSTMESSAGE_DUPLEX__.debug.help() for commands.","color: #4CAF50; font-weight: bold"),k}function R(){return null!==k&&void 0!==S.__POSTMESSAGE_DUPLEX__?.debug}function L(){return k}function _(e){const t=Date.now().toString(36);let i;if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint32Array(2);crypto.getRandomValues(e),i=e[0].toString(36)+e[1].toString(36)}else i=Math.floor(1e10*Math.random()).toString(36);return`${e}${t}${i}_`}class A extends u{constructor(e){if(super(),Object.defineProperty(this,"baseKey",{enumerable:1,configurable:1,writable:1,value:""}),Object.defineProperty(this,"peerKey",{enumerable:1,configurable:1,writable:1,value:""}),Object.defineProperty(this,"reqTime",{enumerable:1,configurable:1,writable:1,value:0}),Object.defineProperty(this,"callbackMap",{enumerable:1,configurable:1,writable:1,value:new Map}),Object.defineProperty(this,"subscribeMap",{enumerable:1,configurable:1,writable:1,value:new Map}),Object.defineProperty(this,"timeout",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"isReady",{enumerable:1,configurable:1,writable:1,value:0}),Object.defineProperty(this,"isDestroyed",{enumerable:1,configurable:1,writable:1,value:0}),Object.defineProperty(this,"postTasks",{enumerable:1,configurable:1,writable:1,value:new Map}),Object.defineProperty(this,"bindOnMessage",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"console",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"maxMessageSize",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"timeoutManager",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"rateLimiter",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"strictValidation",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"requestCmdMap",{enumerable:1,configurable:1,writable:1,value:new Map}),this.timeout=e?.timeout??5e3,this.console=e?.log??("undefined"!=typeof window?window.console:console),this.maxMessageSize=e?.maxMessageSize??1048576,this.strictValidation=e?.strictValidation??1,this.timeoutManager=new l,this.rateLimiter=new c(e?.rateLimit??100,1e3),e?.subscribeMap)for(const t in e.subscribeMap)this.subscribeMap.set(t,e.subscribeMap[t]);var t;this.bindOnMessage=this.onMessage.bind(this),t=this,E.push(new WeakRef(t)),C.activeChannels++,t.on("message:sent",({cmdname:e,requestId:t})=>{C.totalSent++,j({direction:"send",cmdname:e,requestId:t,status:"pending",timestamp:Date.now(),dataSummary:""}),I&&D("send",e,t)}),t.on("message:received",({cmdname:e,requestId:t,isResponse:i})=>{C.totalReceived++;const s=e||"",r=t||"";i?$(r,"ok"):j({direction:"receive",cmdname:s,requestId:r,status:"ok",timestamp:Date.now(),dataSummary:""}),I&&D("receive",s,r,i)}),t.on("timeout",({cmdname:e,requestId:t})=>{C.timeouts++,$(t,"timeout"),I&&function(e,t){const i=T();console.log(`%c[${i}] â± TIMEOUT: ${e||t}`,"color: #FF9800; font-weight: bold")}(e,t)}),t.on("error",({context:e})=>{C.errors++,I&&function(e){const t=T();console.log(`%c[${t}] âŒ ERROR: ${e}`,"color: #F44336; font-weight: bold")}(e||"unknown")}),t.on("destroy",()=>{C.activeChannels=Math.max(0,C.activeChannels-1)})}checkRateLimit(){if(!this.rateLimiter.isEnabled())return 1;if(!this.rateLimiter.tryAcquire()){const e=this.rateLimiter.getCurrentCount(),t=this.rateLimiter.getLimit();return this.log("warn","Rate limit exceeded:",e,"/",t,"messages per second"),this.emit("rate:limited",{currentCount:e,limit:t}),0}return 1}validateMessageSize(e){if(this.maxMessageSize<=0)return;const t=O(e);if(t>this.maxMessageSize){const e=new n(`Message size (${t} bytes) exceeds limit (${this.maxMessageSize} bytes)`,r.MessageSizeExceeded,{size:t,limit:this.maxMessageSize});throw this.emit("error",{error:e,context:"validateMessageSize"}),e}}init(){this.setupMessageListener(),this.sendMessage({requestId:this.baseKey+this.reqTime,msg:"ready",t:this.baseKey})}log(e,...t){this.console?.[e]?.(`[${this.channelType}]: `,...t)}isFromPeer(e){return this.peerKey?e.t&&e.t!==this.peerKey?(this.log("log","Message from non-paired channel, ignored",e.t,"expected:",this.peerKey),0):w(e)&&e.requestId&&!e.requestId.startsWith(this.baseKey)?0:1:1}sendMessage(e,t){this.validateMessageSize(e),this.checkRateLimit()?(e.time=Date.now(),e.t=this.baseKey,this.sendRawMessage(e,t)):this.log("warn","Message dropped due to rate limiting")}async onMessage(e){if(this.log("log","onMessage",e.data),!this.isValidSource(e))return;if(this.strictValidation){const t=g(e.data);if(!t.valid)return this.log("warn","Invalid message structure:",t.error),void this.emit("validation:failed",{reason:t.error,data:e.data})}const t=e.data;if(!t)return;if(!this.isFromPeer(t))return;this.emit("message:received",{cmdname:t.cmdname||"",requestId:t.requestId||"",isResponse:w(t)});const{requestId:i,cmdname:r,t:n}=t,o=i?this.callbackMap.get(i):void 0;if(o&&i)return this.timeoutManager.remove(i),this.requestCmdMap.delete(i),o.resolve(t),void this.deleteCallback(i);if(r){const e=this.subscribeMap.get(r);if(e){try{const r=await e(t);this.sendMessage({requestId:i,ret:s.Success,data:r})}catch(e){const n=e instanceof Error?e.message:String(e);this.sendMessage({req:t,requestId:i,ret:s.ReceiverCallbackError,msg:n||"unknown error"}),this.emit("error",{error:e instanceof Error?e:new Error(n),context:`handler:${r}`})}return}}if(p(t))return n&&!this.peerKey&&(this.peerKey=n,this.log("log","Point-to-point pairing established","self:",this.baseKey,"peer:",this.peerKey)),this.isReady=1,this.executePosts(),this.emit("ready",{peerKey:this.peerKey}),void(w(t)||this.sendMessage({requestId:i,ret:s.Success,msg:"ready"}));i&&!w(t)&&(this.log("warn","No registered handler for:",r||i),this.sendMessage({requestId:i,ret:s.NoSubscribe}))}postMessage(e,t){try{this.sendMessage(e,t),this.emit("message:sent",{cmdname:e.cmdname||"",requestId:e.requestId||""})}catch(t){this.log("error",t,e),this.emit("error",{error:t instanceof Error?t:new Error(String(t)),context:"postMessage"})}}publish(e,t,i){if(this.isDestroyed)return Promise.reject(new n("Cannot publish: channel has been destroyed",r.ConnectionDestroyed,{cmdname:e}));const s=this.baseKey+ ++this.reqTime,o={requestId:s,cmdname:e,data:t};this.requestCmdMap.set(s,e);const a=new Promise((e,t)=>{this.callbackMap.set(s,{resolve:e,reject:t})});return this.log("log","publish",this.isReady,this.postTasks.size),this.isReady?this.doPublish(o,i):this.postTasks.set(s,{data:o,prm:a,options:i}),a}doPublish(e,t){const{requestId:i,cmdname:r}=e,n=t?.timeout??this.timeout;this.timeoutManager.add(i,n,()=>{const t=this.callbackMap.get(i);if(t){const o={req:e,requestId:i,ret:s.TimeOut,time:Date.now(),msg:"timeout"};this.log("error","postmessage timeout",o),this.emit("timeout",{requestId:i,cmdname:r,timeoutMs:n}),t.resolve(o),this.deleteCallback(i),this.requestCmdMap.delete(i)}}),this.postMessage(e,t?.transferables)}deleteCallback(e){this.callbackMap.delete(e),this.postTasks.delete(e),this.timeoutManager.remove(e)}executePosts(){for(const e of this.postTasks.values())this.doPublish(e.data,e.options)}call(e,t,i){return this.publish(e,t,i)}subscribe(e,t){return this.subscribeMap.has(e)&&this.log("warn",`${e} has been subscribed`),this.subscribeMap.set(e,t),this}unSubscribe(e){return this.subscribeMap.delete(e),this}subscribeOnce(e,t){return this.subscribe(e,async i=>(this.unSubscribe(e),t(i)))}getPeerKey(){return this.peerKey}getRateLimitStats(){return{current:this.rateLimiter.getCurrentCount(),limit:this.rateLimiter.getLimit(),remaining:this.rateLimiter.getRemainingCapacity()}}getPendingCount(){return this.callbackMap.size}destroy(){if(this.isDestroyed)return;this.isDestroyed=1,this.emit("destroy",{reason:"explicit"}),function(e){const t=E.findIndex(t=>t.deref()===e);-1!==t&&E.splice(t,1)}(this);const e=new n("Channel has been destroyed",r.ConnectionDestroyed);for(const[t,i]of this.callbackMap)try{i.reject({ret:s.SendCallbackError,msg:e.message})}catch(e){this.log("warn","Error rejecting pending request:",t,e)}this.removeMessageListener(),this.subscribeMap.clear(),this.postTasks.clear(),this.callbackMap.clear(),this.requestCmdMap.clear(),this.timeoutManager.destroy(),this.rateLimiter.reset(),this.destroyEventEmitter(),this.isReady=0,this.peerKey=""}}function x(e){const t=document.createElement("div");t.innerHTML="<a/>";const i=t.firstChild;return i.href=e,i}class F extends A{constructor(e,t){if(super(t),Object.defineProperty(this,"channelType",{enumerable:1,configurable:1,writable:1,value:"IframeChannel"}),Object.defineProperty(this,"isSon",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"link",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"targetOrigin",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"url",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"iframe",{enumerable:1,configurable:1,writable:1,value:void 0}),"string"==typeof e){this.isSon=1,this.url=e,this.link=x(e),this.targetOrigin=this.link.origin;const t=x(document.referrer).origin;if(this.targetOrigin!==t)throw new Error(`çˆ¶é¡µé¢ ${document.referrer} éžæŒ‡å®šåŸŸåçš„é¡µé¢ ${e} ï¼`);this.baseKey=_("son_")}else this.isSon=0,this.iframe=e,this.url=e.src,this.link=x(this.url),this.targetOrigin=this.link.origin,this.baseKey=_("parent_");this.log("log","baseKey",this.baseKey,this.isSon),this.init()}setupMessageListener(){window.addEventListener("message",this.bindOnMessage,1)}removeMessageListener(){window.removeEventListener("message",this.bindOnMessage,1)}sendRawMessage(e,t){try{if(this.isSon){const i=JSON.parse(JSON.stringify(e));t&&t.length>0?parent.postMessage(i,this.targetOrigin,t):parent.postMessage(i,this.targetOrigin)}else t&&t.length>0?this.iframe.contentWindow.postMessage(e,this.targetOrigin,t):this.iframe.contentWindow.postMessage(e,this.targetOrigin)}catch(t){this.log("error",t,e,this.targetOrigin)}}isValidSource(e){return e.origin!==this.targetOrigin?(this.log("log","æœªå¤„ç†",e.data,e,"éžç›®æ ‡æº:",this.targetOrigin),0):this.isSon||e.source===this.iframe?.contentWindow?1:0}log(e,...t){this.console?.[e]?.(`[${this.targetOrigin||"IframeChannel"}](${this.isSon?"son":"parent"}): `,...t)}getTargetOrigin(){return this.targetOrigin}getTargetUrl(){return this.url}}class P extends A{constructor(e,t){if(super(t),Object.defineProperty(this,"channelType",{enumerable:1,configurable:1,writable:1,value:"ServiceWorkerChannel"}),Object.defineProperty(this,"isWorkerSide",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"worker",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"clientId",{enumerable:1,configurable:1,writable:1,value:void 0}),Object.defineProperty(this,"swContainer",{enumerable:1,configurable:1,writable:1,value:void 0}),this.isWorkerSide=t?.isWorkerSide??0,this.isWorkerSide){if("string"!=typeof e)throw new Error("Service Worker ç«¯å¿…é¡»ä¼ å…¥ clientId å­—ç¬¦ä¸²");this.clientId=e,this.baseKey=_("sw_")}else{if(!e||"string"==typeof e)throw new Error("é¡µé¢ç«¯å¿…é¡»ä¼ å…¥æœ‰æ•ˆçš„ ServiceWorker å®žä¾‹");this.worker=e,this.swContainer=navigator.serviceWorker,this.baseKey=_("page_")}this.log("log","baseKey",this.baseKey,this.isWorkerSide?"worker":"page"),this.init()}setupMessageListener(){this.isWorkerSide?self.addEventListener("message",this.bindOnMessage):this.swContainer?.addEventListener("message",this.bindOnMessage)}removeMessageListener(){this.isWorkerSide?self.removeEventListener("message",this.bindOnMessage):this.swContainer?.removeEventListener("message",this.bindOnMessage)}sendRawMessage(e,t){try{const i=JSON.parse(JSON.stringify(e));this.isWorkerSide?this.sendToClient(i,t):t&&t.length>0?this.worker?.postMessage(i,t):this.worker?.postMessage(i)}catch(t){this.log("error","sendMessage error",t,e)}}async sendToClient(e,t){const i=this.clientId;if(i)try{const s=await self.clients.get(i);s?t&&t.length>0?s.postMessage(e,t):s.postMessage(e):this.log("warn","Client not found:",i)}catch(e){this.log("error","sendToClient error",e)}else this.log("error","No clientId available")}isValidSource(e){if(this.isWorkerSide){const t=e.source;return t?.id===this.clientId}return 1}log(e,...t){const i=this.isWorkerSide?"worker":"page";this.console?.[e]?.(`[ServiceWorkerChannel](${i}): `,...t)}getClientId(){return this.clientId}isWorkerAvailable(){return this.isWorkerSide||"activated"===this.worker?.state}static async createFromPage(e){if(!("serviceWorker"in navigator))throw new Error("Service Worker is not supported in this browser");const t=(await navigator.serviceWorker.ready).active||navigator.serviceWorker.controller;if(!t)throw new Error("No active Service Worker found");return new P(t,e)}static createFromWorker(e,t){return new P(e,{...t,isWorkerSide:1})}static createFromEvent(e,t){const i=e.source;if(!i?.id)throw new Error("Invalid message event: no client source");return P.createFromWorker(i.id,t)}}export{A as BaseChannel,n as ChannelError,u as ChannelEventEmitter,r as ErrorCode,F as IframeChannel,e as PKG_NAME,t as PKG_VERSION,s as ReturnCode,P as ServiceWorkerChannel,c as SlidingWindowRateLimiter,l as TimeoutManager,o as createConnectionDestroyedError,h as createHandlerError,a as createTimeoutError,N as enableDebugger,O as estimateMessageSize,L as getDebugger,R as isDebuggerEnabled,p as isReadyMessage,w as isResponseMessage,y as sanitizeForLogging,g as validateMessage,f as validateRequest,v as validateResponse};
//# sourceMappingURL=index.esm.js.map
