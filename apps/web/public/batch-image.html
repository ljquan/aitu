<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰¹é‡å‡ºå›¾å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      height: 100%;
      display: block;
      padding: 16px;
    }

    .main-content {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .image-library-container {
      position: fixed;
      right: 16px;
      top: 16px;
      width: 320px;
      max-height: calc(100vh - 32px);
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      transition: all 0.3s;
      z-index: 1000;
    }

    .image-library-container.collapsed {
      width: 50px;
      height: 50px;
      max-height: 50px;
      overflow: hidden;
    }

    .library-header {
      padding: 12px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%);
      color: white;
      border-radius: 8px 8px 0 0;
    }

    .library-header h3 {
      font-size: 14px;
      font-weight: 600;
      margin: 0;
    }

    .toggle-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .library-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .collapsed .library-content {
      display: none;
    }

    .upload-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }

    .upload-btn {
      width: 100%;
      padding: 8px 12px;
      background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
    }

    #imageUploadInput {
      display: none;
    }

    .upload-hint {
      font-size: 11px;
      color: #999;
      text-align: center;
    }

    .library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
    }

    .library-image {
      aspect-ratio: 1;
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
      position: relative;
    }

    .library-image:hover {
      border-color: #F39C12;
      transform: scale(1.05);
    }

    .library-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .library-image .delete-image-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      background: rgba(220, 53, 69, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .library-image:hover .delete-image-btn {
      display: flex;
    }

    .empty-library {
      text-align: center;
      padding: 20px;
      color: #999;
      font-size: 13px;
    }

    /* å›¾ç‰‡å•å…ƒæ ¼æ ·å¼ */
    .image-cell-content {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      align-items: flex-start;
      padding: 0;
      padding-right: 15px;
      padding-bottom: 15px;
      width: 100%;
      max-width: calc(100% - 15px);
      position: relative;
    }

    .cell-image-thumb {
      width: 40px;
      height: 40px;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
      border: 1px solid #ddd;
    }

    .cell-image-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .cell-image-thumb .remove-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: rgba(220, 53, 69, 0.9);
      color: white;
      border: none;
      width: 16px;
      height: 16px;
      font-size: 10px;
      line-height: 1;
      cursor: pointer;
      display: none;
      padding: 0;
      z-index: 2;
    }

    .cell-image-thumb:hover .remove-btn {
      display: block;
    }

    .add-image-btn {
      width: 40px;
      height: 40px;
      border: 2px dashed #ccc;
      border-radius: 4px;
      background: #f9f9f9;
      color: #999;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .add-image-btn:hover {
      border-color: #F39C12;
      color: #F39C12;
      background: #fff;
    }

    .header {
      background: white;
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 14px;
      color: #666;
    }

    .content {
      flex: 1;
      background: white;
      border-radius: 8px;
      padding: 20px;
      overflow: auto;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .button-primary {
      background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%);
      color: white;
    }

    .button-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
    }

    .button-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .button-secondary {
      background: white;
      color: #666;
      border: 1px solid #ddd;
    }

    .button-secondary:hover {
      background: #f5f5f5;
    }

    .button-group {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .info-box {
      background: #fff3cd;
      border-left: 4px solid #F39C12;
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 16px;
    }

    .info-box p {
      font-size: 13px;
      color: #856404;
      margin: 4px 0;
    }

    /* Excel å¼è¡¨æ ¼æ ·å¼ */
    .excel-table-container {
      flex: 1;
      overflow: auto;
      border: 2px solid #ddd;
      border-radius: 6px;
      background: white;
      position: relative;
      user-select: none;
    }

    .excel-table {
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
      min-width: 100%;
    }

    .excel-table th,
    .excel-table td {
      border: 1px solid #e0e0e0;
      padding: 0;
      position: relative;
      height: 36px;
      min-width: 120px;
    }

    .excel-table th {
      background: #f5f5f5;
      font-weight: 600;
      font-size: 13px;
      color: #666;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* è¡Œå·åˆ— */
    .excel-table th:first-child,
    .excel-table td:first-child {
      width: 50px;
      min-width: 50px;
      background: #f5f5f5;
      text-align: center;
      font-weight: 600;
      color: #666;
      position: sticky;
      left: 0;
      z-index: 5;
    }

    .excel-table th:first-child {
      z-index: 15;
    }

    /* å•å…ƒæ ¼ */
    .excel-cell {
      width: 100%;
      height: 100%;
      padding: 8px;
      display: flex;
      align-items: center;
      cursor: cell;
      position: relative;
      overflow: visible;
    }

    .excel-cell input,
    .excel-cell select,
    .excel-cell textarea {
      width: 100%;
      border: none;
      outline: none;
      background: transparent;
      font-size: 13px;
      font-family: inherit;
      padding: 0;
    }

    .excel-cell textarea {
      resize: none;
      min-height: 20px;
    }

    /* é€‰ä¸­çŠ¶æ€ */
    .excel-cell.selected {
      background: #e3f2fd;
      outline: 2px solid #2196F3;
      outline-offset: -2px;
      z-index: 1;
    }

    .excel-cell.range-selected {
      background: #e3f2fd;
    }

    .excel-cell.active {
      background: white;
      outline: 2px solid #F39C12;
      outline-offset: -2px;
      z-index: 20;
    }

    /* å¡«å……æŸ„ */
    .fill-handle {
      position: absolute;
      bottom: -3px;
      right: -3px;
      width: 8px;
      height: 8px;
      background: #F39C12;
      border: 1px solid white;
      cursor: crosshair;
      z-index: 100;
      display: none;
      pointer-events: auto;
    }

    .excel-cell.active .fill-handle {
      display: block;
    }

    /* æ‹–æ‹½å¡«å……é¢„è§ˆ */
    .excel-cell.fill-preview {
      background: #fff3e0 !important;
      outline: 2px dashed #F39C12 !important;
      outline-offset: -2px;
    }

    /* çŠ¶æ€å¾½ç«  */
    .status-badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
    }

    .status-pending {
      background: #e3f2fd;
      color: #1976d2;
    }

    .status-processing {
      background: #fff3cd;
      color: #856404;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
    }

    .status-failed {
      background: #f8d7da;
      color: #721c24;
    }

    /* è¿›åº¦æ¡ */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 4px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #F39C12, #E67E22);
      transition: width 0.3s ease;
    }

    /* ç¼©ç•¥å›¾ */
    .thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
    }

    .thumbnail:hover {
      opacity: 0.8;
    }

    .no-image {
      width: 60px;
      height: 60px;
      background: #f5f5f5;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 11px;
    }

    /* æ“ä½œæŒ‰é’® */
    .action-btn {
      padding: 4px 8px;
      font-size: 11px;
      border: none;
      background: none;
      color: #F39C12;
      cursor: pointer;
      text-decoration: underline;
    }

    .action-btn:hover {
      color: #E67E22;
    }

    .action-btn.delete {
      color: #dc3545;
    }

    .action-btn.delete:hover {
      color: #c82333;
    }

    /* æç¤ºä¿¡æ¯ */
    .hint-text {
      font-size: 11px;
      color: #999;
      margin-top: 8px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
      <div class="header">
        <h1>ğŸ¨ æ‰¹é‡å‡ºå›¾å·¥å…·</h1>
        <p>Excelå¼æ‰¹é‡AIå›¾ç‰‡ç”Ÿæˆï¼Œæ”¯æŒæ‹–æ‹½å¡«å……ã€å¤šé€‰ã€é”®ç›˜å¯¼èˆª</p>
      </div>

      <div class="content">
        <div class="info-box">
          <p><strong>å¿«æ·é”®ï¼š</strong>æ–¹å‘é”®å¯¼èˆª | Enterç¼–è¾‘ | Ctrl+Cå¤åˆ¶ | Ctrl+Vç²˜è´´ | æ‹–æ‹½å³ä¸‹è§’å¡«å……æŸ„æ‰¹é‡å¤åˆ¶</p>
          <p id="debug-info" style="color: #333;">
            <strong>çŠ¶æ€ï¼š</strong>
            <span id="config-status">ç­‰å¾…é…ç½®...</span>
          </p>
        </div>

        <div class="button-group">
          <button class="button button-secondary" onclick="addRows(5)">
            â• æ·»åŠ  5 è¡Œ
          </button>
          <button class="button button-secondary" onclick="deleteSelected()">
            ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­
          </button>
          <button class="button button-primary" id="generateBtn" onclick="startBatchGeneration()">
            ğŸš€ å¼€å§‹ç”Ÿæˆ
          </button>
          <button class="button button-secondary" onclick="clearCompleted()">
            ğŸ§¹ æ¸…é™¤å·²å®Œæˆ
          </button>
        </div>

        <div class="excel-table-container" id="tableContainer">
          <table class="excel-table" id="excelTable">
            <thead>
              <tr>
                <th>#</th>
                <th style="width: 300px;">æç¤ºè¯</th>
                <th style="width: 100px;">å°ºå¯¸</th>
                <th style="width: 150px;">å‚è€ƒå›¾ç‰‡</th>
                <th style="width: 120px;">çŠ¶æ€</th>
                <th style="width: 80px;">é¢„è§ˆ</th>
                <th style="width: 100px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
          </table>
        </div>

        <p class="hint-text">
          æç¤ºï¼šåŒå‡»å•å…ƒæ ¼ç¼–è¾‘ | æ‹–æ‹½å¡«å……æŸ„æ‰¹é‡å¡«å…… | Shift+ç‚¹å‡»å¤šé€‰ | é€‰ä¸­è¡Œåç‚¹å‡»å³ä¾§å›¾ç‰‡åº“æ·»åŠ å‚è€ƒå›¾
        </p>
      </div>
    </div>

    <!-- å›¾ç‰‡åº“ -->
    <div class="image-library-container" id="imageLibrary">
      <div class="library-header">
        <h3>å›¾ç‰‡åº“</h3>
        <button class="toggle-btn" onclick="toggleLibrary()">â—€</button>
      </div>
      <div class="library-content">
        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
          <input type="file" id="imageUploadInput" accept="image/*" multiple onchange="handleImageUpload(event)">
          <button class="upload-btn" onclick="document.getElementById('imageUploadInput').click()">
            ğŸ“¤ ä¸Šä¼ å›¾ç‰‡
          </button>
          <p class="upload-hint">æ”¯æŒ JPGã€PNGã€GIF ç­‰æ ¼å¼</p>
        </div>

        <!-- å›¾ç‰‡ç½‘æ ¼ -->
        <div class="library-grid" id="libraryGrid">
          <!-- å›¾ç‰‡å°†é€šè¿‡ JS åŠ¨æ€åŠ è½½ -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // æ›´æ–°è°ƒè¯•ä¿¡æ¯ï¼ˆéœ€è¦å…ˆå®šä¹‰ï¼‰
    function updateDebugInfo(text) {
      const statusEl = document.getElementById('config-status');
      if (statusEl) {
        statusEl.textContent = text;
      }
      console.log('[BatchImage Debug]', text);
    }

    // ===============================
    // å…¨å±€é…ç½®å’ŒçŠ¶æ€
    // ===============================
    let appConfig = {
      apiKey: '',
      baseUrl: 'https://api.tu-zi.com/v1',
      imageModel: 'gemini-2.5-flash-image-vip'
    };

    // ä» URL å‚æ•°è·å– toolId
    const urlParams = new URLSearchParams(window.location.search);
    let toolId = urlParams.get('toolId') || 'batch-image-tool';

    console.log('[BatchImage] Tool ID from URL:', toolId);
    updateDebugInfo('å·¥å…· ID: ' + toolId);

    // ä»»åŠ¡æ•°æ®
    let tasks = [];
    let taskIdCounter = 1;
    let isGenerating = false;

    // Excel è¡¨æ ¼çŠ¶æ€
    let activeCell = null;
    let selectedCells = [];
    let isSelecting = false;
    let isDraggingFillHandle = false;
    let fillStartCell = null;
    let clipboard = [];

    // å›¾ç‰‡åº“çŠ¶æ€
    let isLibraryCollapsed = false;
    let imageLibrary = []; // åˆå§‹ä¸ºç©ºï¼Œç­‰å¾…ç”¨æˆ·ä¸Šä¼ 

    // ===============================
    // å·¥å…·é€šä¿¡åè®®
    // ===============================
    let isInitialized = false; // é˜²æ­¢é‡å¤åˆå§‹åŒ–

    window.addEventListener('message', (event) => {
      const message = event.data;

      if (message && message.version === '1.0' && message.type === 'board:init') {
        console.log('[BatchImage] Received init message:', message);
        updateDebugInfo('æ”¶åˆ°åˆå§‹åŒ–æ¶ˆæ¯');

        if (message.toolId) {
          toolId = message.toolId;
        }

        if (message.payload && message.payload.config) {
          const config = message.payload.config;
          if (config.apiKey) {
            appConfig.apiKey = config.apiKey;
            updateDebugInfo('API Key å·²æ¥æ”¶ âœ“');
          }
          if (config.baseUrl) {
            appConfig.baseUrl = config.baseUrl;
          }
          if (config.imageModel) {
            appConfig.imageModel = config.imageModel;
          }
        }

        isInitialized = true;
        // æ”¶åˆ° init åä¸å†å‘é€ readyï¼Œé¿å…å¾ªç¯
      }
    });

    window.addEventListener('load', () => {
      console.log('[BatchImage] Tool loaded');
      updateDebugInfo('é¡µé¢å·²åŠ è½½ï¼Œå‘é€å°±ç»ªé€šçŸ¥');

      // åˆå§‹åŒ–è¡¨æ ¼
      initTable();
      setupTableEvents();

      // é¡µé¢åŠ è½½åå‘é€ readyï¼Œè§¦å‘ä¸»åº”ç”¨å‘é€ init
      sendToolMessage({
        type: 'tool:ready',
        payload: {}
      });
    });

    function sendToolMessage(message, timeout = 120000) {
      if (message.type === 'tool:generate-image') {
        return new Promise((resolve, reject) => {
          const messageId = `batch-${Date.now()}-${Math.random()}`;

          const toolMessage = {
            version: '1.0',
            type: message.type,
            toolId: toolId,
            messageId: messageId,
            payload: {
              ...message.payload,
              messageId: messageId
            },
            timestamp: Date.now()
          };

          const timeoutId = setTimeout(() => {
            window.removeEventListener('message', messageHandler);
            reject(new Error('ç”Ÿæˆè¶…æ—¶'));
          }, timeout);

          function messageHandler(event) {
            if (event.data.responseId === messageId) {
              clearTimeout(timeoutId);
              window.removeEventListener('message', messageHandler);

              if (event.data.success && event.data.result) {
                resolve(event.data.result);
              } else {
                reject(new Error(event.data.error || 'ç”Ÿæˆå¤±è´¥'));
              }
            }
          }

          window.addEventListener('message', messageHandler);
          window.parent.postMessage(toolMessage, '*');
        });
      } else {
        const toolMessage = {
          version: '1.0',
          type: message.type,
          toolId: toolId,
          messageId: `msg-${Date.now()}-${Math.random()}`,
          payload: message.payload || {},
          timestamp: Date.now()
        };

        window.parent.postMessage(toolMessage, '*');
      }
    }

    // ===============================
    // Excel è¡¨æ ¼åŠŸèƒ½
    // ===============================

    function initTable() {
      // æ·»åŠ åˆå§‹è¡Œ
      for (let i = 0; i < 10; i++) {
        addRow(i === 0 ? 'A cute cat sitting on a windowsill' : '');
      }
      renderTable();
      // åˆå§‹åŒ–å›¾ç‰‡åº“
      renderImageLibrary();
    }

    function addRow(promptText = '') {
      const task = {
        id: taskIdCounter++,
        prompt: promptText,
        size: '1x1',  // ä¿®æ”¹ä¸º API æ”¯æŒçš„æ¯”ä¾‹æ ¼å¼
        images: [],  // å‚è€ƒå›¾ç‰‡æ•°ç»„
        status: 'pending',
        progress: 0,
        imageUrl: null,
        error: null
      };
      tasks.push(task);
    }

    function addRows(count) {
      for (let i = 0; i < count; i++) {
        addRow();
      }
      renderTable();
    }

    function deleteSelected() {
      if (selectedCells.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¡Œ');
        return;
      }

      const rowsToDelete = new Set(selectedCells.map(c => c.row));
      tasks = tasks.filter((_, index) => !rowsToDelete.has(index));

      selectedCells = [];
      activeCell = null;
      renderTable();
    }

    function clearCompleted() {
      tasks = tasks.filter(t => t.status !== 'completed');
      selectedCells = [];
      activeCell = null;
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      tasks.forEach((task, rowIndex) => {
        const tr = document.createElement('tr');

        // è¡Œå·
        const tdIndex = document.createElement('td');
        tdIndex.textContent = rowIndex + 1;
        tr.appendChild(tdIndex);

        // æç¤ºè¯
        tr.appendChild(createCell(rowIndex, 'prompt', task.prompt, 'textarea'));

        // å°ºå¯¸
        tr.appendChild(createCell(rowIndex, 'size', task.size, 'select'));

        // å‚è€ƒå›¾ç‰‡
        const tdImages = document.createElement('td');
        const imagesCell = createCellElement(rowIndex, 'images');
        imagesCell.innerHTML = getImageCellHTML(task, rowIndex);
        tdImages.appendChild(imagesCell);
        tr.appendChild(tdImages);

        // çŠ¶æ€
        const tdStatus = document.createElement('td');
        const statusCell = createCellElement(rowIndex, 'status');
        statusCell.innerHTML = getStatusHTML(task);
        tdStatus.appendChild(statusCell);
        tr.appendChild(tdStatus);

        // é¢„è§ˆ
        const tdPreview = document.createElement('td');
        const previewCell = createCellElement(rowIndex, 'preview');
        previewCell.innerHTML = getPreviewHTML(task);
        previewCell.style.justifyContent = 'center';
        tdPreview.appendChild(previewCell);
        tr.appendChild(tdPreview);

        // æ“ä½œ
        const tdAction = document.createElement('td');
        const actionCell = createCellElement(rowIndex, 'action');
        actionCell.innerHTML = getActionHTML(task);
        actionCell.style.justifyContent = 'center';
        tdAction.appendChild(actionCell);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
    }

    function createCell(rowIndex, colName, value, inputType) {
      const td = document.createElement('td');
      const cellDiv = createCellElement(rowIndex, colName);

      if (inputType === 'textarea') {
        const textarea = document.createElement('textarea');
        textarea.value = value;
        textarea.rows = 2;
        textarea.readOnly = true;
        textarea.addEventListener('blur', () => {
          saveCell(rowIndex, colName, textarea.value);
        });
        textarea.addEventListener('keydown', (e) => handleCellKeydown(e, rowIndex, colName));
        cellDiv.appendChild(textarea);
      } else if (inputType === 'select') {
        // åˆ›å»ºä¸€ä¸ªåªè¯»æ˜¾ç¤ºçš„ div
        const displayDiv = document.createElement('div');
        displayDiv.className = 'select-display';
        displayDiv.textContent = value;
        displayDiv.style.cssText = `
          width: 100%;
          height: 100%;
          padding: 8px;
          cursor: cell;
          background: white;
        `;

        // åˆ›å»ºçœŸæ­£çš„ selectï¼ˆéšè—ï¼‰
        const select = document.createElement('select');
        const sizes = ['1x1', '2x3', '3x2', '3x4', '4x3', '4x5', '5x4', '9x16', '16x9', '21x9'];
        sizes.forEach(size => {
          const option = document.createElement('option');
          option.value = size;
          option.textContent = size;
          option.selected = value === size;
          select.appendChild(option);
        });
        select.style.display = 'none';

        select.addEventListener('change', (e) => {
          console.log('Select changed to:', select.value);
          displayDiv.textContent = select.value;
          saveCell(rowIndex, colName, select.value);
          // éšè— selectï¼Œæ˜¾ç¤º display
          select.style.display = 'none';
          displayDiv.style.display = 'block';
        });

        select.addEventListener('blur', () => {
          console.log('Select blurred');
          // éšè— selectï¼Œæ˜¾ç¤º display
          select.style.display = 'none';
          displayDiv.style.display = 'block';
        });

        // åŒå‡»æ—¶æ˜¾ç¤º selectï¼Œéšè— display
        displayDiv.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          console.log('Display div double clicked');
          displayDiv.style.display = 'none';
          select.style.display = 'block';
          select.focus();
        });

        cellDiv.appendChild(displayDiv);
        cellDiv.appendChild(select);
      } else {
        const input = document.createElement('input');
        input.value = value;
        input.readOnly = true;
        input.addEventListener('blur', () => {
          saveCell(rowIndex, colName, input.value);
        });
        input.addEventListener('keydown', (e) => handleCellKeydown(e, rowIndex, colName));
        cellDiv.appendChild(input);
      }

      td.appendChild(cellDiv);
      return td;
    }

    function createCellElement(rowIndex, colName) {
      const cellDiv = document.createElement('div');
      cellDiv.className = 'excel-cell';
      cellDiv.dataset.row = rowIndex;
      cellDiv.dataset.col = colName;

      // å¡«å……æŸ„ï¼ˆåªåœ¨å¯ç¼–è¾‘åˆ—æ˜¾ç¤ºï¼‰
      if (['prompt', 'size', 'images'].includes(colName)) {
        const fillHandle = document.createElement('div');
        fillHandle.className = 'fill-handle';
        cellDiv.appendChild(fillHandle);

        fillHandle.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          startFillDrag(rowIndex, colName);
        });
      }

      // å•å‡»é€‰ä¸­
      cellDiv.addEventListener('click', (e) => handleCellClick(e, rowIndex, colName));

      // åŒå‡»è¿›å…¥ç¼–è¾‘
      cellDiv.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        activateCell(rowIndex, colName);
      });

      return cellDiv;
    }

    function getStatusHTML(task) {
      let html = `<span class="status-badge status-${task.status}">`;
      html += { pending: 'å¾…å¤„ç†', processing: 'ç”Ÿæˆä¸­', completed: 'å·²å®Œæˆ', failed: 'å¤±è´¥' }[task.status];
      html += '</span>';

      if (task.status === 'processing') {
        html += `<div class="progress-bar"><div class="progress-fill" style="width: ${task.progress}%"></div></div>`;
      }

      if (task.error) {
        html += `<div style="font-size: 10px; color: #dc3545; margin-top: 4px;">${task.error}</div>`;
      }

      return html;
    }

    function getPreviewHTML(task) {
      if (task.imageUrl) {
        return `<img src="${task.imageUrl}" class="thumbnail" onclick="window.open('${task.imageUrl}', '_blank')">`;
      }
      return '<div class="no-image">æš‚æ— </div>';
    }

    function getActionHTML(task) {
      let html = '';
      if (task.imageUrl) {
        html += `<button class="action-btn" onclick="downloadImage('${task.imageUrl}', 'image-${task.id}.png')">ä¸‹è½½</button>`;
      }
      return html;
    }

    function handleCellClick(e, row, col) {
      if (e.shiftKey && activeCell) {
        // Shift + ç‚¹å‡»ï¼šé€‰æ‹©èŒƒå›´
        selectRange(activeCell.row, activeCell.col, row, col);
      } else if (e.ctrlKey || e.metaKey) {
        // Ctrl + ç‚¹å‡»ï¼šæ·»åŠ åˆ°é€‰åŒº
        toggleCellSelection(row, col);
      } else {
        // æ™®é€šç‚¹å‡»ï¼šå•é€‰
        selectCell(row, col);
      }
    }

    function selectCell(row, col) {
      clearSelection();
      activeCell = { row, col };
      selectedCells = [{ row, col }];
      updateCellStyles();
    }

    function toggleCellSelection(row, col) {
      const index = selectedCells.findIndex(c => c.row === row && c.col === col);
      if (index >= 0) {
        selectedCells.splice(index, 1);
      } else {
        selectedCells.push({ row, col });
      }
      updateCellStyles();
    }

    function selectRange(startRow, startCol, endRow, endCol) {
      clearSelection();
      selectedCells = [];

      const minRow = Math.min(startRow, endRow);
      const maxRow = Math.max(startRow, endRow);

      for (let r = minRow; r <= maxRow; r++) {
        selectedCells.push({ row: r, col: startCol });
      }

      activeCell = { row: endRow, col: endCol };
      updateCellStyles();
    }

    function clearSelection() {
      document.querySelectorAll('.excel-cell').forEach(cell => {
        cell.classList.remove('selected', 'active', 'range-selected');
      });
    }

    function updateCellStyles() {
      clearSelection();

      selectedCells.forEach(({ row, col }) => {
        const cell = document.querySelector(`.excel-cell[data-row="${row}"][data-col="${col}"]`);
        if (cell) {
          cell.classList.add('range-selected');
        }
      });

      if (activeCell) {
        const cell = document.querySelector(`.excel-cell[data-row="${activeCell.row}"][data-col="${activeCell.col}"]`);
        if (cell) {
          cell.classList.remove('range-selected');
          cell.classList.add('active');
        }
      }
    }

    function activateCell(row, col) {
      selectCell(row, col);
      const cell = document.querySelector(`.excel-cell[data-row="${row}"][data-col="${col}"]`);
      if (cell) {
        const input = cell.querySelector('input, textarea');

        if (input) {
          input.readOnly = false;
          input.focus();
          if (input.select) input.select();
        }
        // select ç°åœ¨é€šè¿‡ displayDiv çš„åŒå‡»äº‹ä»¶å¤„ç†
      }
    }

    function saveCell(row, col, value) {
      console.log('=== saveCell called ===');
      console.log('Row:', row, 'Col:', col, 'Value:', value);

      const task = tasks[row];
      if (task && col in task) {
        console.log('Before update - task[col]:', task[col]);
        task[col] = value;
        console.log('After update - task[col]:', task[col]);
        console.log('Full task:', task);

        // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥æ˜¾ç¤ºæ›´æ–°åçš„å€¼
        console.log('Calling renderTable...');
        renderTable();
      } else {
        console.error('Task not found or col not in task:', { task, col });
      }

      const cell = document.querySelector(`.excel-cell[data-row="${row}"][data-col="${col}"]`);
      if (cell) {
        const input = cell.querySelector('input, textarea');
        if (input) input.readOnly = true;
      }
    }

    function handleCellKeydown(e, row, col) {
      const input = e.target;

      // Enter: ä¿å­˜å¹¶ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œ
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        input.blur();
        if (row < tasks.length - 1) {
          activateCell(row + 1, col);
        }
      }
      // Escape: å–æ¶ˆç¼–è¾‘
      else if (e.key === 'Escape') {
        input.blur();
      }
      // æ–¹å‘é”®å¯¼èˆª
      else if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key) && input.readOnly) {
        e.preventDefault();
        navigateCell(e.key, row, col);
      }
      // Ctrl+C: å¤åˆ¶
      else if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        copySelection();
      }
      // Ctrl+V: ç²˜è´´
      else if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
        pasteSelection(row, col);
      }
    }

    function navigateCell(key, row, col) {
      let newRow = row;
      let newCol = col;

      const cols = ['prompt', 'size', 'images'];
      const colIndex = cols.indexOf(col);

      switch (key) {
        case 'ArrowUp':
          newRow = Math.max(0, row - 1);
          break;
        case 'ArrowDown':
          newRow = Math.min(tasks.length - 1, row + 1);
          break;
        case 'ArrowLeft':
          if (colIndex > 0) newCol = cols[colIndex - 1];
          break;
        case 'ArrowRight':
          if (colIndex < cols.length - 1) newCol = cols[colIndex + 1];
          break;
      }

      selectCell(newRow, newCol);
    }

    function copySelection() {
      clipboard = selectedCells.map(({ row, col }) => {
        const value = tasks[row]?.[col] || '';
        return {
          col,
          // å¦‚æœæ˜¯ images åˆ—ï¼Œæ·±æ‹·è´æ•°ç»„
          value: col === 'images' && Array.isArray(value) ? [...value] : value
        };
      });
      console.log('Copied:', clipboard);
    }

    function pasteSelection(row, col) {
      if (clipboard.length === 0) return;

      clipboard.forEach(({ col: clipCol, value }, index) => {
        const targetRow = row + index;
        if (targetRow < tasks.length && clipCol in tasks[targetRow]) {
          // å¦‚æœæ˜¯ images åˆ—ï¼Œæ·±æ‹·è´æ•°ç»„
          if (clipCol === 'images' && Array.isArray(value)) {
            tasks[targetRow][clipCol] = [...value];
          } else {
            tasks[targetRow][clipCol] = value;
          }
        }
      });

      renderTable();
    }

    function startFillDrag(row, col) {
      isDraggingFillHandle = true;
      fillStartCell = { row, col };
      document.body.style.cursor = 'crosshair';

      // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
      document.querySelectorAll('.excel-cell.fill-preview').forEach(cell => {
        cell.classList.remove('fill-preview');
      });

      const handleMouseMove = (e) => {
        // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
        document.querySelectorAll('.excel-cell.fill-preview').forEach(cell => {
          cell.classList.remove('fill-preview');
        });

        // è·å–å½“å‰é¼ æ ‡ä¸‹çš„å•å…ƒæ ¼
        const target = document.elementFromPoint(e.clientX, e.clientY);
        const cell = target?.closest('.excel-cell');

        if (cell && cell.dataset.col === col) {
          const currentRow = parseInt(cell.dataset.row);
          const minRow = Math.min(row, currentRow);
          const maxRow = Math.max(row, currentRow);

          // é«˜äº®å¡«å……åŒºåŸŸ
          for (let r = minRow; r <= maxRow; r++) {
            const targetCell = document.querySelector(`.excel-cell[data-row="${r}"][data-col="${col}"]`);
            if (targetCell) {
              targetCell.classList.add('fill-preview');
            }
          }
        }
      };

      const handleMouseUp = (e) => {
        isDraggingFillHandle = false;
        document.body.style.cursor = '';

        // æ¸…é™¤é«˜äº®
        document.querySelectorAll('.excel-cell.fill-preview').forEach(cell => {
          cell.classList.remove('fill-preview');
        });

        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);

        // æŸ¥æ‰¾ç»“æŸå•å…ƒæ ¼
        const target = document.elementFromPoint(e.clientX, e.clientY);
        const cell = target?.closest('.excel-cell');
        if (cell) {
          const endRow = parseInt(cell.dataset.row);
          const endCol = cell.dataset.col;

          if (endCol === col) {
            fillCells(row, endRow, col);
          }
        }
      };

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    }

    function fillCells(startRow, endRow, col) {
      const startValue = tasks[startRow][col];
      const minRow = Math.min(startRow, endRow);
      const maxRow = Math.max(startRow, endRow);

      for (let r = minRow; r <= maxRow; r++) {
        if (r !== startRow && tasks[r]) {
          // å¦‚æœæ˜¯ images åˆ—ï¼Œéœ€è¦æ·±æ‹·è´æ•°ç»„
          if (col === 'images' && Array.isArray(startValue)) {
            tasks[r][col] = [...startValue];
          } else {
            tasks[r][col] = startValue;
          }
        }
      }

      renderTable();
    }

    function setupTableEvents() {
      // å…¨å±€é”®ç›˜äº‹ä»¶
      document.addEventListener('keydown', (e) => {
        if (!activeCell) return;

        const { row, col } = activeCell;
        const cell = document.querySelector(`.excel-cell[data-row="${row}"][data-col="${col}"]`);
        const input = cell?.querySelector('input, textarea, select');

        if (input && !input.readOnly) return; // æ­£åœ¨ç¼–è¾‘ï¼Œä¸å¤„ç†

        handleCellKeydown(e, row, col);
      });
    }

    // ===============================
    // æ‰¹é‡ç”ŸæˆåŠŸèƒ½
    // ===============================

    async function startBatchGeneration() {
      if (!appConfig.apiKey) {
        alert('æœªæ£€æµ‹åˆ° API Keyï¼Œè¯·å…ˆåœ¨ aitu ä¸­é…ç½® API Key');
        return;
      }

      if (isGenerating) {
        alert('å·²æœ‰ç”Ÿæˆä»»åŠ¡åœ¨è¿›è¡Œä¸­');
        return;
      }

      const pendingTasks = tasks.filter(t => t.status === 'pending' || t.status === 'failed');
      if (pendingTasks.length === 0) {
        alert('æ²¡æœ‰å¾…å¤„ç†çš„ä»»åŠ¡');
        return;
      }

      const emptyPrompts = pendingTasks.filter(t => !t.prompt || t.prompt.trim() === '');
      if (emptyPrompts.length > 0) {
        alert('è¯·å¡«å†™æ‰€æœ‰è¡Œçš„æç¤ºè¯');
        return;
      }

      isGenerating = true;
      const generateBtn = document.getElementById('generateBtn');
      generateBtn.disabled = true;
      generateBtn.textContent = 'â³ ç”Ÿæˆä¸­...';

      for (const task of pendingTasks) {
        await generateSingleTask(task);
      }

      isGenerating = false;
      generateBtn.disabled = false;
      generateBtn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
      alert('æ‰¹é‡ç”Ÿæˆå®Œæˆï¼');
    }

    async function generateSingleTask(task) {
      const taskIndex = tasks.indexOf(task);
      tasks[taskIndex].status = 'processing';
      tasks[taskIndex].progress = 10;
      renderTable();

      try {
        // size ç°åœ¨æ˜¯æ¯”ä¾‹æ ¼å¼ï¼ˆå¦‚ 1x1, 16x9ï¼‰ï¼Œç›´æ¥ä¼ é€’ç»™ API
        const result = await sendToolMessage({
          type: 'tool:generate-image',
          payload: {
            prompt: task.prompt,
            size: task.size,  // ç›´æ¥ä¼ é€’æ¯”ä¾‹æ ¼å¼
            aspectRatio: 'auto'
          }
        }, 120000);

        tasks[taskIndex].status = 'completed';
        tasks[taskIndex].progress = 100;
        tasks[taskIndex].imageUrl = result.url;
        tasks[taskIndex].error = null;
      } catch (error) {
        console.error('ç”Ÿæˆå¤±è´¥:', error);
        tasks[taskIndex].status = 'failed';
        tasks[taskIndex].progress = 0;
        tasks[taskIndex].error = error.message || 'ç”Ÿæˆå¤±è´¥';
      }

      renderTable();
    }

    async function downloadImage(url, filename) {
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(blobUrl);
      } catch (error) {
        console.error('ä¸‹è½½å¤±è´¥:', error);
        alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·å°è¯•å³é”®ä¿å­˜å›¾ç‰‡');
      }
    }

    // ===============================
    // å›¾ç‰‡åº“åŠŸèƒ½
    // ===============================

    /**
     * æ¸²æŸ“å›¾ç‰‡åº“
     */
    function renderImageLibrary() {
      const libraryGrid = document.getElementById('libraryGrid');
      libraryGrid.innerHTML = '';

      if (imageLibrary.length === 0) {
        libraryGrid.innerHTML = '<div class="empty-library">æš‚æ— å›¾ç‰‡<br>è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ä¸Šä¼ </div>';
        return;
      }

      imageLibrary.forEach((imageUrl, index) => {
        const imageItem = document.createElement('div');
        imageItem.className = 'library-image';
        imageItem.innerHTML = `
          <img src="${imageUrl}" alt="Image ${index + 1}">
          <button class="delete-image-btn" onclick="deleteLibraryImage(${index})">Ã—</button>
        `;

        // ç‚¹å‡»å›¾ç‰‡æ·»åŠ åˆ°é€‰ä¸­çš„è¡Œ
        imageItem.querySelector('img').addEventListener('click', () => {
          onLibraryImageClick(imageUrl);
        });

        libraryGrid.appendChild(imageItem);
      });
    }

    /**
     * å¤„ç†å›¾ç‰‡ä¸Šä¼ 
     */
    function handleImageUpload(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;

      Array.from(files).forEach(file => {
        if (!file.type.startsWith('image/')) {
          console.warn('è·³è¿‡éå›¾ç‰‡æ–‡ä»¶:', file.name);
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          const dataUrl = e.target.result;
          imageLibrary.push(dataUrl);
          renderImageLibrary();
        };
        reader.readAsDataURL(file);
      });

      // æ¸…ç©º input ä»¥å…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
      event.target.value = '';
    }

    /**
     * åˆ é™¤å›¾ç‰‡åº“ä¸­çš„å›¾ç‰‡
     */
    function deleteLibraryImage(index) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
        imageLibrary.splice(index, 1);
        renderImageLibrary();
      }
    }

    /**
     * åˆ‡æ¢å›¾ç‰‡åº“æ˜¾ç¤º/éšè—
     */
    function toggleLibrary() {
      const library = document.getElementById('imageLibrary');
      isLibraryCollapsed = !isLibraryCollapsed;

      if (isLibraryCollapsed) {
        library.classList.add('collapsed');
      } else {
        library.classList.remove('collapsed');
      }
    }

    /**
     * ç‚¹å‡»å›¾ç‰‡åº“ä¸­çš„å›¾ç‰‡
     */
    function onLibraryImageClick(imageUrl) {
      // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„è¡Œ
      if (selectedCells.length === 0) {
        alert('è¯·å…ˆé€‰ä¸­è¦æ·»åŠ å‚è€ƒå›¾ç‰‡çš„è¡Œ');
        return;
      }

      // è·å–é€‰ä¸­çš„è¡Œï¼ˆå»é‡ï¼‰
      const selectedRows = [...new Set(selectedCells.map(c => c.row))];

      // ä¸ºæ¯ä¸ªé€‰ä¸­çš„è¡Œæ·»åŠ å›¾ç‰‡
      selectedRows.forEach(rowIndex => {
        if (tasks[rowIndex]) {
          // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ è¯¥å›¾ç‰‡
          if (!tasks[rowIndex].images.includes(imageUrl)) {
            tasks[rowIndex].images.push(imageUrl);
          }
        }
      });

      // é‡æ–°æ¸²æŸ“è¡¨æ ¼
      renderTable();
    }

    /**
     * è·å–å›¾ç‰‡å•å…ƒæ ¼çš„ HTML
     */
    function getImageCellHTML(task, rowIndex) {
      const images = task.images || [];

      let html = '<div class="image-cell-content">';

      // æ¸²æŸ“å·²æ·»åŠ çš„å›¾ç‰‡
      images.forEach(imageUrl => {
        html += `
          <div class="cell-image-thumb">
            <img src="${imageUrl}" alt="Reference">
            <button class="remove-btn" onclick="removeImageFromCell(${rowIndex}, '${imageUrl}')">Ã—</button>
          </div>
        `;
      });

      // æ·»åŠ "æ·»åŠ å›¾ç‰‡"æŒ‰é’®
      html += `
        <div class="add-image-btn" onclick="showLibraryForRow(${rowIndex})">
          +
        </div>
      `;

      // æ·»åŠ ä¸€ä¸ªå¡«å……å ä½ç¬¦ï¼Œç¡®ä¿å³ä¸‹è§’æœ‰ç©ºé—´æ˜¾ç¤ºå¡«å……æŸ„
      html += '<div style="flex: 1; min-height: 12px;"></div>';

      html += '</div>';
      return html;
    }

    /**
     * ä»å•å…ƒæ ¼ç§»é™¤å›¾ç‰‡
     */
    function removeImageFromCell(rowIndex, imageUrl) {
      if (tasks[rowIndex]) {
        const imageIndex = tasks[rowIndex].images.indexOf(imageUrl);
        if (imageIndex > -1) {
          tasks[rowIndex].images.splice(imageIndex, 1);
          renderTable();
        }
      }
    }

    /**
     * ç‚¹å‡»"+"æŒ‰é’®æ—¶é€‰ä¸­è¯¥è¡Œå¹¶æç¤º
     */
    function showLibraryForRow(rowIndex) {
      // é€‰ä¸­è¯¥è¡Œ
      selectCell(rowIndex, 'images');

      // ç¡®ä¿å›¾ç‰‡åº“å±•å¼€
      const library = document.getElementById('imageLibrary');
      if (isLibraryCollapsed) {
        toggleLibrary();
      }

      // æ»šåŠ¨åˆ°å›¾ç‰‡åº“é¡¶éƒ¨
      const libraryContent = library.querySelector('.library-content');
      if (libraryContent) {
        libraryContent.scrollTop = 0;
      }
    }
  </script>
</body>
</html>
