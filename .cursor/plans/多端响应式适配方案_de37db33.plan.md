---
name: 多端响应式适配方案
overview: 系统性地对Aitu白板应用进行手机端、平板端适配，解决遮挡、触控不响应等问题，同时确保PC端现有效果不受影响。
todos:
  - id: responsive-infra
    content: 创建响应式基础设施（_responsive.scss、useDeviceType hook）
    status: completed
  - id: unified-toolbar
    content: 适配统一工具栏 - 移动端横向布局/可收起
    status: completed
  - id: ai-input-bar
    content: 适配AI输入栏 - 移动端全宽、安全区域
    status: completed
  - id: view-navigation
    content: 适配视图导航 - 移动端缩小/右上角
    status: completed
  - id: chat-drawer
    content: 适配聊天抽屉 - 移动端全屏显示
    status: completed
  - id: popup-toolbar
    content: 适配弹出工具栏 - 增加触控区域
    status: completed
  - id: dialogs
    content: 适配对话框组件 - 移动端全屏/安全区域
    status: completed
  - id: touch-fix
    content: 修复触控问题 - 优化双指缩放阻止逻辑
    status: completed
  - id: e2e-test
    content: E2E测试验证 - 多视口尺寸测试
    status: completed
isProject: false
---

# 多端响应式适配方案

## 问题分析

### 当前状态

- 项目已有移动端检测（`mobile-detect`库 + 视口宽度检测）
- 部分组件有响应式样式（断点：768px、640px、480px）
- 缺乏系统性的多端适配

### 核心问题

1. **遮挡问题**：多个固定定位元素（工具栏、AI输入栏、视图导航等）在小屏幕上相互遮挡
2. **触控问题**：`prevent-pinch-zoom-service.ts` 阻止多点触摸可能影响正常交互
3. **布局问题**：组件尺寸未针对移动端优化

## 适配策略

### 设备断点定义

- **移动端竖屏**：`max-width: 640px`
- **移动端横屏/平板竖屏**：`641px - 768px`
- **平板横屏**：`769px - 1024px`
- **桌面端**：`> 1024px`

### 布局策略

```
PC端（现状保持）:
┌──────────────────────────────────────────┐
│ ┌────┐                        ┌────────┐ │
│ │工具│                        │ 视图   │ │
│ │栏  │                        │ 导航   │ │
│ │    │      画布区域          │        │ │
│ │    │                        │        │ │
│ │    │                        │        │ │
│ │    │    ┌─────────────┐     │        │ │
│ └────┘    │  AI输入栏   │     └────────┘ │
│           └─────────────┘                │
└──────────────────────────────────────────┘

移动端竖屏（优化）:
┌────────────────────┐
│   ┌──────────┐     │
│   │ 视图导航 │     │
│   └──────────┘     │
│                    │
│      画布区域      │
│                    │
│                    │
│ ┌─────────────────┐│
│ │    AI输入栏     ││
│ └─────────────────┘│
│ ┌──┐  (工具栏收起) │
│ │≡ │               │
│ └──┘               │
└────────────────────┘
```

## 关键组件适配

### 1. 统一工具栏 (`unified-toolbar`)

**文件**: `packages/drawnix/src/styles/index.scss`

```scss
// 移动端样式
@media (max-width: 768px) {
  .unified-toolbar {
    position: fixed;
    left: 8px;
    bottom: env(safe-area-inset-bottom, 8px);
    top: auto;
    height: auto;
    max-height: 60vh;
    flex-direction: row;
    width: auto;
    max-width: calc(100vw - 16px);
    border-radius: 16px;
  }
}
```

### 2. AI输入栏 (`ai-input-bar`)

**文件**: `packages/drawnix/src/components/ai-input-bar/ai-input-bar.scss`

- 移动端：左侧不偏移，宽度占满（留边距）
- 添加 safe-area-inset 支持
- 缩小按钮和输入框尺寸

### 3. 聊天抽屉 (`chat-drawer`)

**文件**: `packages/drawnix/src/components/chat-drawer/chat-drawer.scss`

- 移动端：全屏显示，添加关闭手势
- 添加 safe-area-inset 支持

### 4. 视图导航 (`view-navigation`)

**文件**: `packages/drawnix/src/components/view-navigation/view-navigation.scss`

- 移动端：移动到右上角，缩小尺寸
- 小地图默认收起

### 5. 弹出工具栏 (`popup-toolbar`)

**文件**: `packages/drawnix/src/components/toolbar/popup-toolbar/`

- 移动端：增加触控区域，调整弹出位置

### 6. 对话框组件

**文件**: `packages/drawnix/src/components/ttd-dialog/`

- 移动端：全屏/近全屏显示
- 添加底部安全区域

## 全局样式变量

**新建文件**: `packages/drawnix/src/styles/_responsive.scss`

```scss
// 设备断点
$breakpoint-mobile: 640px;
$breakpoint-tablet: 768px;
$breakpoint-tablet-landscape: 1024px;

// Safe area
$safe-area-top: env(safe-area-inset-top, 0px);
$safe-area-bottom: env(safe-area-inset-bottom, 0px);
$safe-area-left: env(safe-area-inset-left, 0px);
$safe-area-right: env(safe-area-inset-right, 0px);

// 响应式 mixin
@mixin mobile {
  @media (max-width: #{$breakpoint-mobile}) { @content; }
}
@mixin tablet {
  @media (min-width: #{$breakpoint-mobile + 1}) and (max-width: #{$breakpoint-tablet}) { @content; }
}
@mixin tablet-and-below {
  @media (max-width: #{$breakpoint-tablet}) { @content; }
}
@mixin desktop {
  @media (min-width: #{$breakpoint-tablet-landscape + 1}) { @content; }
}
```

## 触控优化

**文件**: `packages/drawnix/src/services/prevent-pinch-zoom-service.ts`

- 修改逻辑：仅在画布区域阻止双指缩放
- 允许交互元素的触控事件正常传递

## React Hook 增强

**文件**: `packages/drawnix/src/hooks/useDeviceType.ts` (新建)

```typescript
export function useDeviceType() {
  const [deviceType, setDeviceType] = useState<'mobile' | 'tablet' | 'desktop'>('desktop');
  
  useEffect(() => {
    const checkDevice = () => {
      const width = window.innerWidth;
      if (width <= 640) return 'mobile';
      if (width <= 1024) return 'tablet';
      return 'desktop';
    };
    // ... resize listener
  }, []);
  
  return deviceType;
}
```

## 验证方法

1. **浏览器开发者工具**：使用设备模拟器测试常见设备尺寸
2. **E2E测试**：使用 Playwright 配置不同视口尺寸
3. **真机测试**：在实际设备上验证触控交互

## 实施顺序

1. 创建响应式基础设施（变量、mixin、hook）
2. 适配统一工具栏（影响最大的组件）
3. 适配AI输入栏
4. 适配视图导航
5. 适配聊天抽屉
6. 适配对话框组件
7. 修复触控问题
8. E2E测试验证