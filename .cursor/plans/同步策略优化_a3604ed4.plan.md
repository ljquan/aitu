---
name: 同步策略优化
overview: 优化 JSON 数据加密同步和媒体文件自动同步策略，增强数据安全性和用户体验。
todos:
  - id: crypto-service
    content: 创建加密服务 crypto-service.ts，实现 AES-GCM 加密/解密
    status: completed
  - id: serializer-encrypt
    content: 修改 data-serializer.ts，集成加密到序列化/反序列化流程
    status: completed
  - id: sync-engine-encrypt
    content: 修改 sync-engine.ts，处理首次创建 Gist 时的加密流程
    status: completed
  - id: auto-sync-media
    content: 修改 image.ts 和 video.ts，插入本地媒体时自动触发同步
    status: cancelled
  - id: batch-sync-ui
    content: 修改 MediaLibraryGrid.tsx，添加批量同步/上传按钮
    status: completed
  - id: backward-compat
    content: 确保向后兼容：加密数据和旧明文数据都能正确处理
    status: completed
isProject: false
---

# 同步策略优化计划

## 一、JSON 数据加密同步

### 1.1 加密策略设计

使用 Web Crypto API 实现 AES-GCM 加密：

- **密钥派生**：使用 PBKDF2 从 gist id + 固定盐派生 256 位密钥
- **加密算法**：AES-256-GCM（提供加密和完整性校验）
- **IV（初始化向量）**：每次加密随机生成 12 字节 IV

```
加密流程：gist_id → PBKDF2 → AES Key → AES-GCM(plaintext) → IV + ciphertext
解密流程：IV + ciphertext → AES-GCM(key) → plaintext
```

### 1.2 新增加密服务

创建 `packages/drawnix/src/services/github-sync/crypto-service.ts`：

```typescript
// 核心接口
export interface CryptoService {
  encrypt(data: string, gistId: string): Promise<string>;  // 返回 base64
  decrypt(encrypted: string, gistId: string): Promise<string>;
  deriveKey(gistId: string): Promise<CryptoKey>;
}
```

### 1.3 修改序列化流程

修改 [data-serializer.ts](packages/drawnix/src/services/github-sync/data-serializer.ts)：

- `serializeToGistFiles()`: JSON → 加密 → base64 字符串
- `deserializeFromGistFiles()`: base64 → 解密 → JSON

**首次创建 Gist 的处理**：

1. 首次推送时先创建空 Gist 获取 id
2. 然后用 id 加密数据并更新 Gist

---

## 二、媒体文件同步优化

### 2.1 Gist API 限制

GitHub Gist API 只支持 JSON 文本，无法直接存储二进制。方案：

- **保持 Base64**：简单可靠，但体积增加 33%
- **优化**：对图片使用压缩（如 WebP 转换），减少传输体积

### 2.2 自动同步策略

**触发时机**：插入本地媒体到画布时自动同步

**实现方案**：

修改 [image.ts](packages/drawnix/src/data/image.ts) 的 `insertImageFromUrl()`：

```typescript
// 插入后检查是否为本地媒体
if (isLocalMedia(imageUrl)) {
  // 后台异步同步，不阻塞插入
  mediaSyncService.syncTaskMedia(taskId).catch(console.error);
}
```

同样修改 [video.ts](packages/drawnix/src/data/video.ts) 的 `insertVideoFromUrl()`。

### 2.3 URL 媒体手动同步

对于外部 URL 媒体，需要用户手动点击同步：

- 在任务卡片上显示"同步"按钮（已有 [TaskSyncButton.tsx](packages/drawnix/src/components/task-queue/TaskSyncButton.tsx)）
- 同步时先下载 URL 内容到 Cache Storage，再上传到 Gist

---

## 三、素材库批量同步

### 3.1 UI 增强

修改 [MediaLibraryGrid.tsx](packages/drawnix/src/components/media-library/MediaLibraryGrid.tsx)：

添加批量操作栏：

- "全选"复选框
- "同步选中"按钮
- "上传选中"按钮（上传到 Gist）

### 3.2 批量同步逻辑

扩展 [media-sync-service.ts](packages/drawnix/src/services/github-sync/media-sync-service.ts)：

```typescript
// 已有方法，扩展使用
async syncMultipleTasks(taskIds: string[], onProgress?): Promise<BatchMediaSyncResult>;
```

---

## 四、数据结构变更

### 4.1 Gist 文件格式

加密后的文件格式：

```json
{
  "v": 1,
  "encrypted": true,
  "iv": "base64_iv",
  "data": "base64_ciphertext"
}
```

### 4.2 向后兼容

解密时检查 `encrypted` 标志：

- 如果不存在或为 false，按明文处理（兼容旧数据）
- 如果为 true，先解密再处理

---

## 五、实现顺序

1. **加密服务** - 核心加密/解密功能
2. **序列化改造** - 集成加密到数据同步流程
3. **自动同步** - 插入画布时自动同步本地媒体
4. **素材库批量操作** - UI 和批量处理逻辑
5. **测试和调试** - 确保新旧数据兼容

---

## 六、关键文件清单


| 操作  | 文件                                                                   |
| --- | -------------------------------------------------------------------- |
| 新增  | `packages/drawnix/src/services/github-sync/crypto-service.ts`        |
| 修改  | `packages/drawnix/src/services/github-sync/data-serializer.ts`       |
| 修改  | `packages/drawnix/src/services/github-sync/sync-engine.ts`           |
| 修改  | `packages/drawnix/src/services/github-sync/media-sync-service.ts`    |
| 修改  | `packages/drawnix/src/data/image.ts`                                 |
| 修改  | `packages/drawnix/src/data/video.ts`                                 |
| 修改  | `packages/drawnix/src/components/media-library/MediaLibraryGrid.tsx` |
| 修改  | `packages/drawnix/src/services/github-sync/types.ts`                 |


