## 元素选择

画板中有三类元素：
- 图片
- 文字
- 图形（图片、文字之外的都是图形）
选中元素,点击"AI 图片生成"按钮打开弹窗的处理规则如下：
现有规则：把选中的图片全部插入到AI 图片生成表单的图片列表，把选中的文字填入到AI 图片生成表单的图片描述。
针对存在图形的情况，新增规则：
1、如果存在图形元素，图形元素与之重叠的元素都变成图形元素，比如图片或文字和图形有重叠（位置相交），则图片或文字变成该图形元素的一部分。所有图形元素组合起来生成一张图片，插入到AI 图片生成表单的图片列表末尾。
2、剩余的所有图片分别插入到AI 图片生成表单的图片列表开头。
3、剩余的所有文字填入到AI 图片生成表单的图片描述。
4、如果文字与图片重叠，则把文字和图片作为一个整体生成一个图片（todo）


### 插入
关闭弹窗,原先被选中的元素不应被取消选中状态   
点击插入，如果打开弹窗前，有选中的元素，图片应该插入到在所有选中元素的几何中心的最下方+20px位置。


## 视频
点击单个图片的popup-toolbar(只有图片才需要),添加一个AI生成视频按钮,点击AI生成视频按钮打开类似'/Users/ljq/code/self/drawn
  ix/packages/drawnix/src/components/ttd-dialog/ai-image-generation.tsx'的弹窗,左边表单的上传图片只支持一张图,右边是生成的
  视频预览


对于视频元素,点击的popup-toolbar出现选择视频帧的图标,点击图标打开视频帧选择弹窗.视频帧选择弹窗上方默认是该视频最后一帧的图片，图片下有进度条，可以拖动或输入选择指定位置的帧图片，点击确认，插入到画布中该视频的底下。



## 代码优化
结合项目技术栈和业界最佳实践,写一个编码规范到docs目录,并把规范加入到claude规则中
仔细review一下commitid=7edd04f之后提交的所有代码,把大文件(超过500行的)拆成若干个小的文件模块,对于重复的代码请抽象成一个模块或者函数,总而言之要提升代码的可读性和可维护性.


## 工作流
实现一个基于JSON数据的工作流系统，一条工作流是一个数组，每个元素是一个工作节点，工作节点包括输入输出和调用接口的定义。基于这个工作流，可以转换成一个工作表单的UI，用户可以在工作表单上输入参数，然后点击提交按钮，工作流会根据参数调用接口，生成结果。希望这个工作流方案，可以同时解决目前的AI图片生成和AI视频生成弹窗的问题。AI图片、视频生成的工作流会定义一个icon和工作流命名，当工作流添加到draw-toolbar中时，会显示icon和工作流命名，点击icon，会打开工作流弹窗，用户可以在工作流弹窗上输入参数，然后点击提交按钮，工作流会根据参数调用接口，生成结果。这样就把AI图片、视频生成的工作流，从弹窗中抽离出来，变成一个工作流，用户可以在工作流中输入参数，然后点击提交按钮，工作流会根据参数调用接口，生成结果。



## 埋点上报
设计一种声明式埋点上报的方案，比如在元素上加属性track="xxx"，点击时就会自动上报xxx事件，并给所有可点击元素加上埋点。在现的umami有上报基础上增加项目版本号version以及当前页面地址location.href的参数。



## AI对话框
在AI输入框发送时：
1.只有选择元素，没有任何输入文字，使用设置中配置的图片模型和该模型对应的默认配置，如果选中元素包含文本（如果是多个可以用\n合成一个）作为prompt参数，如果未包含文本，默认prompt：单张图片是“做同款”，多张图片是“把这些图片按照合理的逻辑融合成一张图片”。
2.输入内容有选择模型、参数，则解析出模型和参数，填入到接口调用的模型和参数中，如果未指定参数则使用默认参数。
3.如果输入内容指定了数量，则按照AI图片、视频弹窗指定数量的生成逻辑。
对于前三种情况，发送后与AI图片、视频弹窗的生成逻辑类似，会把请求添加到任务队列。
4.如果输入内容除了选择模型、参数、数量外，还包含了其他内容，则走agent流程，先调文本模型，得到工作流，再调用工作流，生成结果。调用文本模型的同时，需要在对话抽屉中创建一个新的对话，以输入内容为标题，在对话抽屉上展示对话到工作流全流程，便于调试和定位问题。
对于前4中情况，都应该用工作流的方式来支持，前3种情况，可以通过正则的方式来把输入转换成工作流后执行。