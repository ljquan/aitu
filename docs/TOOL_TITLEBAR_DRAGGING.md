# å·¥å…·æ ‡é¢˜æ æ‹–åŠ¨åŠŸèƒ½

## é—®é¢˜æè¿°

ç”»å¸ƒä¸Šçš„å·¥å…·æ˜¯é€šè¿‡ iframe æ–¹å¼æ’å…¥çš„ï¼Œç”±äºŽç”»å¸ƒä¸Šçš„å…ƒç´ æ”¯æŒæ‹–åŠ¨ï¼Œå¯¼è‡´ iframe å†…çš„é¡µé¢æ— æ³•æ­£å¸¸ç‚¹å‡»å’Œæ»šåŠ¨ã€‚

## è§£å†³æ–¹æ¡ˆ

æ·»åŠ ä¸€ä¸ªå·¥å…·æ ‡é¢˜æ ï¼Œå°†æ‹–åŠ¨åŠŸèƒ½åªåº”ç”¨åœ¨æ ‡é¢˜æ ä¸Šï¼Œiframe é¡µé¢å¯ä»¥æ­£å¸¸æ“ä½œã€‚

## å®žçŽ°ç»†èŠ‚

### 1. æ ‡é¢˜æ ç»“æž„ (`tool.generator.ts`)

æ·»åŠ äº†ä¸€ä¸ªæ ‡é¢˜æ ç»„ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹å…ƒç´ ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ”§ å·¥å…·åç§°                         [â†»]    â”‚  â† æ ‡é¢˜æ ï¼ˆå¯æ‹–åŠ¨ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚          iframe å†…å®¹åŒºåŸŸ                    â”‚  â† å¯äº¤äº’åŒºåŸŸ
â”‚        ï¼ˆå¯ç‚¹å‡»ã€æ»šåŠ¨ï¼‰                      â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ‡é¢˜æ åŠŸèƒ½ï¼š
- **å·¥å…·å›¾æ ‡** (ðŸ”§): è§†è§‰æ ‡è¯†
- **å·¥å…·åç§°**: æ˜¾ç¤ºå·¥å…·çš„åç§°ï¼ˆæ¥è‡ª `element.metadata.name`ï¼‰
- **åˆ·æ–°æŒ‰é’®** (â†»): é‡æ–°åŠ è½½ iframe

### 2. æ‹–åŠ¨é€»è¾‘ä¿®æ”¹

#### åŽŸæ¥çš„é€»è¾‘ï¼ˆæœ‰é—®é¢˜ï¼‰ï¼š
```typescript
// æ•´ä¸ªå·¥å…·å…ƒç´ éƒ½å¯æ‹–åŠ¨
cursor: move;
iframe.style.pointerEvents = 'none'; // iframe æ— æ³•äº¤äº’
```

#### æ–°çš„é€»è¾‘ï¼ˆä¿®å¤åŽï¼‰ï¼š
```typescript
// åªæœ‰æ ‡é¢˜æ å¯æ‹–åŠ¨
titleBar.style.cursor = 'move';
iframe.style.pointerEvents = 'auto'; // iframe å¯ä»¥æ­£å¸¸äº¤äº’

// ç¢°æ’žæ£€æµ‹åªåœ¨æ ‡é¢˜æ å’Œè¾¹ç¼˜ç”Ÿæ•ˆ
function isHitToolElement(element, point) {
  const inTitleBar = y >= rect.y && y <= rect.y + 36;
  const nearEdge = /* è¾¹ç¼˜æ£€æµ‹ */;
  return inTitleBar || nearEdge;
}
```

### 3. å…³é”®ä¿®æ”¹ç‚¹

#### `tool.generator.ts` - åˆ›å»ºæ ‡é¢˜æ 
```typescript
// å®¹å™¨æ”¹ä¸º flex å¸ƒå±€
container.style.cssText = `
  display: flex;
  flex-direction: column;
  ...
`;

// æ·»åŠ æ ‡é¢˜æ ï¼ˆ36px é«˜ï¼‰
const titleBar = this.createTitleBar(element);
titleBar.setAttribute('data-draggable', 'true');
titleBar.style.cursor = 'move';

// iframe å¯ç”¨äº¤äº’
iframe.style.pointerEvents = 'auto';
```

#### `with-tool.ts` - ä¿®æ”¹ç¢°æ’žæ£€æµ‹
```typescript
function isHitToolElement(element: PlaitTool, point: Point): boolean {
  const TITLEBAR_HEIGHT = 36;
  const EDGE_THRESHOLD = 8;

  // åªæœ‰æ ‡é¢˜æ æˆ–è¾¹ç¼˜æ‰ç®—å‘½ä¸­
  const inTitleBar = y >= rect.y && y <= rect.y + TITLEBAR_HEIGHT;
  const nearEdge = /* ... */;

  return inTitleBar || nearEdge;
}
```

#### `tool.component.scss` - æ ·å¼æ›´æ–°
```scss
.plait-tool-titlebar {
  height: 36px;
  cursor: move;
  background: linear-gradient(180deg, #f5f5f5 0%, #ebebeb 100%);

  &:hover {
    background: linear-gradient(180deg, #f8f8f8 0%, #efefef 100%);
  }
}

.plait-tool-content iframe {
  pointer-events: auto; // ç¡®ä¿å¯äº¤äº’
}
```

## åŠŸèƒ½ç‰¹æ€§

### 1. æ‹–åŠ¨åŠŸèƒ½
- âœ… ç‚¹å‡»æ ‡é¢˜æ å¯ä»¥æ‹–åŠ¨æ•´ä¸ªå·¥å…·
- âœ… ç‚¹å‡»è¾¹ç¼˜å¯ä»¥è°ƒæ•´å¤§å°ï¼ˆresizeï¼‰
- âœ… ç‚¹å‡» iframe å†…å®¹ä¸ä¼šè§¦å‘æ‹–åŠ¨

### 2. æ ‡é¢˜æ æŒ‰é’®

#### åˆ·æ–°æŒ‰é’® (â†»)
- é‡æ–°åŠ è½½ iframe
- ç”¨äºŽåˆ·æ–°å·¥å…·å†…å®¹

### 3. è§†è§‰åé¦ˆ

#### æ™®é€šçŠ¶æ€
- æµ…ç°è‰²æ¸å˜èƒŒæ™¯
- `cursor: move` æŒ‡ç¤ºå¯æ‹–åŠ¨

#### Hover çŠ¶æ€
- èƒŒæ™¯å˜äº®
- æŒ‰é’®æ˜¾ç¤º hover æ•ˆæžœ

#### é€‰ä¸­çŠ¶æ€
- æ ‡é¢˜æ å˜ä¸ºæµ…è“è‰²
- è¾¹æ¡†é«˜äº®æ˜¾ç¤º

#### æ‹–åŠ¨çŠ¶æ€
- `cursor: grabbing`
- é˜´å½±å¢žå¼º

## äº¤äº’è¡Œä¸º

### iframe å†…å®¹åŒºåŸŸ
- âœ… **å¯ä»¥ç‚¹å‡»**ï¼šé“¾æŽ¥ã€æŒ‰é’®ç­‰å…ƒç´ æ­£å¸¸å“åº”
- âœ… **å¯ä»¥æ»šåŠ¨**ï¼šé¼ æ ‡æ»šè½®ã€è§¦æ‘¸æ»šåŠ¨éƒ½æ­£å¸¸
- âœ… **å¯ä»¥é€‰æ‹©æ–‡æœ¬**ï¼šå¯ä»¥å¤åˆ¶å†…å®¹
- âœ… **å¯ä»¥è¾“å…¥**ï¼šè¡¨å•è¾“å…¥æ¡†æ­£å¸¸å·¥ä½œ

### æ ‡é¢˜æ åŒºåŸŸ
- âœ… **å¯ä»¥æ‹–åŠ¨**ï¼šé¼ æ ‡æŒ‰ä¸‹å¹¶ç§»åŠ¨å¯æ‹–åŠ¨å·¥å…·
- âœ… **æŒ‰é’®å¯ç‚¹å‡»**ï¼šåˆ·æ–°ã€å…³é—­æŒ‰é’®æ­£å¸¸å·¥ä½œ
- âŒ **ä¸èƒ½é€‰æ‹©æ–‡æœ¬**ï¼š`user-select: none` é¿å…è¯¯é€‰

### è¾¹ç¼˜åŒºåŸŸ
- âœ… **å¯ä»¥è°ƒæ•´å¤§å°**ï¼šæ‹–åŠ¨è¾¹ç¼˜è°ƒæ•´å·¥å…·å°ºå¯¸
- âœ… **æ˜¾ç¤º resize å…‰æ ‡**ï¼šæ ¹æ®ä½ç½®æ˜¾ç¤ºå¯¹åº”å…‰æ ‡

## ä»£ç ç»“æž„

```
packages/drawnix/src/
â”œâ”€â”€ components/tool-element/
â”‚   â”œâ”€â”€ tool.generator.ts           # ä¿®æ”¹ï¼šæ·»åŠ æ ‡é¢˜æ åˆ›å»ºé€»è¾‘
â”‚   â”œâ”€â”€ tool.component.ts           # æ— ä¿®æ”¹
â”‚   â””â”€â”€ tool.component.scss         # ä¿®æ”¹ï¼šæ·»åŠ æ ‡é¢˜æ æ ·å¼
â””â”€â”€ plugins/
    â””â”€â”€ with-tool.ts                # ä¿®æ”¹ï¼šç¢°æ’žæ£€æµ‹é€»è¾‘
```

## æµ‹è¯•æ–¹æ³•

### 1. æ‹–åŠ¨æµ‹è¯•
```
1. åœ¨ç”»å¸ƒä¸Šæ’å…¥ä¸€ä¸ªå·¥å…·
2. ç‚¹å‡»æ ‡é¢˜æ å¹¶æ‹–åŠ¨ âœ… åº”è¯¥å¯ä»¥ç§»åŠ¨
3. ç‚¹å‡» iframe å†…å®¹ âŒ ä¸åº”è¯¥è§¦å‘æ‹–åŠ¨
```

### 2. iframe äº¤äº’æµ‹è¯•
```
1. åœ¨ç”»å¸ƒä¸Šæ’å…¥ä¸€ä¸ªå·¥å…·ï¼ˆå¦‚ posemaniacsï¼‰
2. ç‚¹å‡» iframe å†…çš„é“¾æŽ¥ âœ… åº”è¯¥è·³è½¬
3. æ»šåŠ¨ iframe å†…å®¹ âœ… åº”è¯¥æ­£å¸¸æ»šåŠ¨
4. é€‰æ‹© iframe å†…æ–‡æœ¬ âœ… åº”è¯¥å¯ä»¥é€‰æ‹©
```

### 3. æµ‹è¯•æ–¹æ³•

```
1. ç‚¹å‡»åˆ·æ–°æŒ‰é’® âœ… iframe åº”è¯¥é‡æ–°åŠ è½½
2. æŒ‰é’® hover âœ… åº”è¯¥æ˜¾ç¤ºèƒŒæ™¯é«˜äº®
```

### 4. è°ƒæ•´å¤§å°æµ‹è¯•

```
1. ç§»åŠ¨é¼ æ ‡åˆ°å·¥å…·è¾¹ç¼˜
2. åº”è¯¥æ˜¾ç¤º resize å…‰æ ‡
3. æ‹–åŠ¨è¾¹ç¼˜è°ƒæ•´å¤§å° âœ… åº”è¯¥æ­£å¸¸å·¥ä½œ
```

## å…¼å®¹æ€§

- âœ… Chrome/Edge: å®Œå…¨æ”¯æŒ
- âœ… Firefox: å®Œå…¨æ”¯æŒ
- âœ… Safari: å®Œå…¨æ”¯æŒ
- âœ… ç§»åŠ¨æµè§ˆå™¨: è§¦æ‘¸æ‹–åŠ¨æ”¯æŒ

## æ€§èƒ½ä¼˜åŒ–

### 1. äº‹ä»¶å§”æ‰˜
- æŒ‰é’®äº‹ä»¶ä½¿ç”¨ `stopPropagation()` é¿å…å†’æ³¡
- å‡å°‘äº‹ä»¶ç›‘å¬å™¨æ•°é‡

### 2. CSS ä¼˜åŒ–
- ä½¿ç”¨ CSS æ¸å˜è€Œéžå›¾ç‰‡
- ç¡¬ä»¶åŠ é€Ÿçš„ transform åŠ¨ç”»
- æœ€å°åŒ–é‡æŽ’/é‡ç»˜

### 3. å†…å­˜ç®¡ç†
- ç»„ä»¶é”€æ¯æ—¶ç§»é™¤äº‹ä»¶ç›‘å¬
- åŠæ—¶æ¸…ç† iframe å¼•ç”¨

## å·²çŸ¥é™åˆ¶

### 1. æ ‡é¢˜æ é«˜åº¦å›ºå®š
- å½“å‰å›ºå®šä¸º 36px
- æœªæ¥å¯é…ç½®

### 2. æœ€å°åŒ–åŠŸèƒ½æœªå®žçŽ°
- ä»£ç ä¸­å·²é¢„ç•™æŽ¥å£
- å¯åœ¨åŽç»­ç‰ˆæœ¬å®žçŽ°

### 3. æ ‡é¢˜æ è‡ªå®šä¹‰
- å½“å‰æ ·å¼å›ºå®š
- æœªæ¥å¯æ”¯æŒä¸»é¢˜å®šåˆ¶

## æœªæ¥æ”¹è¿›

### çŸ­æœŸ
- [ ] æ”¯æŒåŒå‡»æ ‡é¢˜æ æœ€å¤§åŒ–/è¿˜åŽŸ
- [ ] æ”¯æŒæ ‡é¢˜æ å³é”®èœå•
- [ ] æ”¯æŒæ‹–æ‹½æ ‡é¢˜æ åˆ°è¾¹ç¼˜å¸é™„

### ä¸­æœŸ
- [ ] æ”¯æŒæœ€å°åŒ–åˆ°æ‰˜ç›˜
- [ ] æ”¯æŒå¤šçª—å£ç®¡ç†
- [ ] æ”¯æŒå·¥å…·é—´é€šä¿¡

### é•¿æœŸ
- [ ] æ”¯æŒæ ‡é¢˜æ ä¸»é¢˜å®šåˆ¶
- [ ] æ”¯æŒè‡ªå®šä¹‰æ ‡é¢˜æ æŒ‰é’®
- [ ] æ”¯æŒæ ‡é¢˜æ æ’ä»¶ç³»ç»Ÿ

## ç›¸å…³æ–‡ä»¶

- `packages/drawnix/src/components/tool-element/tool.generator.ts` - æ ‡é¢˜æ åˆ›å»º
- `packages/drawnix/src/components/tool-element/tool.component.scss` - æ ‡é¢˜æ æ ·å¼
- `packages/drawnix/src/plugins/with-tool.ts` - æ‹–åŠ¨é€»è¾‘
- `packages/drawnix/src/types/toolbox.types.ts` - ç±»åž‹å®šä¹‰

## æ€»ç»“

é€šè¿‡æ·»åŠ æ ‡é¢˜æ å¹¶ä¿®æ”¹ç¢°æ’žæ£€æµ‹é€»è¾‘ï¼ŒæˆåŠŸè§£å†³äº†å·¥å…·æ‹–åŠ¨ä¸Ž iframe äº¤äº’å†²çªçš„é—®é¢˜ï¼š

âœ… **æ‹–åŠ¨åŠŸèƒ½**ï¼šä¿ç•™åœ¨æ ‡é¢˜æ å’Œè¾¹ç¼˜
âœ… **iframe äº¤äº’**ï¼šå®Œå…¨æ¢å¤ï¼Œå¯ç‚¹å‡»å¯æ»šåŠ¨
âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šç¬¦åˆæ¡Œé¢åº”ç”¨ä¹ æƒ¯
âœ… **ä»£ç è´¨é‡**ï¼šç»“æž„æ¸…æ™°ï¼Œæ˜“äºŽç»´æŠ¤
